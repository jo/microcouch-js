var ft=Object.create;var Z=Object.defineProperty;var dt=Object.getOwnPropertyDescriptor;var pt=Object.getOwnPropertyNames;var gt=Object.getPrototypeOf,mt=Object.prototype.hasOwnProperty;var vt=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var wt=(a,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let c of pt(t))!mt.call(a,c)&&c!==s&&Z(a,c,{get:()=>t[c],enumerable:!(i=dt(t,c))||i.enumerable});return a};var O=(a,t,s)=>(s=a!=null?ft(gt(a)):{},wt(t||!a||!a.__esModule?Z(s,"default",{value:a,enumerable:!0}):s,a));var W=vt((X,Y)=>{(function(a){if(typeof X=="object")Y.exports=a();else if(typeof define=="function"&&define.amd)define(a);else{var t;try{t=window}catch{t=self}t.SparkMD5=a()}})(function(a){"use strict";var t=function(u,h){return u+h&4294967295},s=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function i(u,h,r,e,o,n){return h=t(t(h,u),t(e,n)),t(h<<o|h>>>32-o,r)}function c(u,h){var r=u[0],e=u[1],o=u[2],n=u[3];r+=(e&o|~e&n)+h[0]-680876936|0,r=(r<<7|r>>>25)+e|0,n+=(r&e|~r&o)+h[1]-389564586|0,n=(n<<12|n>>>20)+r|0,o+=(n&r|~n&e)+h[2]+606105819|0,o=(o<<17|o>>>15)+n|0,e+=(o&n|~o&r)+h[3]-1044525330|0,e=(e<<22|e>>>10)+o|0,r+=(e&o|~e&n)+h[4]-176418897|0,r=(r<<7|r>>>25)+e|0,n+=(r&e|~r&o)+h[5]+1200080426|0,n=(n<<12|n>>>20)+r|0,o+=(n&r|~n&e)+h[6]-1473231341|0,o=(o<<17|o>>>15)+n|0,e+=(o&n|~o&r)+h[7]-45705983|0,e=(e<<22|e>>>10)+o|0,r+=(e&o|~e&n)+h[8]+1770035416|0,r=(r<<7|r>>>25)+e|0,n+=(r&e|~r&o)+h[9]-1958414417|0,n=(n<<12|n>>>20)+r|0,o+=(n&r|~n&e)+h[10]-42063|0,o=(o<<17|o>>>15)+n|0,e+=(o&n|~o&r)+h[11]-1990404162|0,e=(e<<22|e>>>10)+o|0,r+=(e&o|~e&n)+h[12]+1804603682|0,r=(r<<7|r>>>25)+e|0,n+=(r&e|~r&o)+h[13]-40341101|0,n=(n<<12|n>>>20)+r|0,o+=(n&r|~n&e)+h[14]-1502002290|0,o=(o<<17|o>>>15)+n|0,e+=(o&n|~o&r)+h[15]+1236535329|0,e=(e<<22|e>>>10)+o|0,r+=(e&n|o&~n)+h[1]-165796510|0,r=(r<<5|r>>>27)+e|0,n+=(r&o|e&~o)+h[6]-1069501632|0,n=(n<<9|n>>>23)+r|0,o+=(n&e|r&~e)+h[11]+643717713|0,o=(o<<14|o>>>18)+n|0,e+=(o&r|n&~r)+h[0]-373897302|0,e=(e<<20|e>>>12)+o|0,r+=(e&n|o&~n)+h[5]-701558691|0,r=(r<<5|r>>>27)+e|0,n+=(r&o|e&~o)+h[10]+38016083|0,n=(n<<9|n>>>23)+r|0,o+=(n&e|r&~e)+h[15]-660478335|0,o=(o<<14|o>>>18)+n|0,e+=(o&r|n&~r)+h[4]-405537848|0,e=(e<<20|e>>>12)+o|0,r+=(e&n|o&~n)+h[9]+568446438|0,r=(r<<5|r>>>27)+e|0,n+=(r&o|e&~o)+h[14]-1019803690|0,n=(n<<9|n>>>23)+r|0,o+=(n&e|r&~e)+h[3]-187363961|0,o=(o<<14|o>>>18)+n|0,e+=(o&r|n&~r)+h[8]+1163531501|0,e=(e<<20|e>>>12)+o|0,r+=(e&n|o&~n)+h[13]-1444681467|0,r=(r<<5|r>>>27)+e|0,n+=(r&o|e&~o)+h[2]-51403784|0,n=(n<<9|n>>>23)+r|0,o+=(n&e|r&~e)+h[7]+1735328473|0,o=(o<<14|o>>>18)+n|0,e+=(o&r|n&~r)+h[12]-1926607734|0,e=(e<<20|e>>>12)+o|0,r+=(e^o^n)+h[5]-378558|0,r=(r<<4|r>>>28)+e|0,n+=(r^e^o)+h[8]-2022574463|0,n=(n<<11|n>>>21)+r|0,o+=(n^r^e)+h[11]+1839030562|0,o=(o<<16|o>>>16)+n|0,e+=(o^n^r)+h[14]-35309556|0,e=(e<<23|e>>>9)+o|0,r+=(e^o^n)+h[1]-1530992060|0,r=(r<<4|r>>>28)+e|0,n+=(r^e^o)+h[4]+1272893353|0,n=(n<<11|n>>>21)+r|0,o+=(n^r^e)+h[7]-155497632|0,o=(o<<16|o>>>16)+n|0,e+=(o^n^r)+h[10]-1094730640|0,e=(e<<23|e>>>9)+o|0,r+=(e^o^n)+h[13]+681279174|0,r=(r<<4|r>>>28)+e|0,n+=(r^e^o)+h[0]-358537222|0,n=(n<<11|n>>>21)+r|0,o+=(n^r^e)+h[3]-722521979|0,o=(o<<16|o>>>16)+n|0,e+=(o^n^r)+h[6]+76029189|0,e=(e<<23|e>>>9)+o|0,r+=(e^o^n)+h[9]-640364487|0,r=(r<<4|r>>>28)+e|0,n+=(r^e^o)+h[12]-421815835|0,n=(n<<11|n>>>21)+r|0,o+=(n^r^e)+h[15]+530742520|0,o=(o<<16|o>>>16)+n|0,e+=(o^n^r)+h[2]-995338651|0,e=(e<<23|e>>>9)+o|0,r+=(o^(e|~n))+h[0]-198630844|0,r=(r<<6|r>>>26)+e|0,n+=(e^(r|~o))+h[7]+1126891415|0,n=(n<<10|n>>>22)+r|0,o+=(r^(n|~e))+h[14]-1416354905|0,o=(o<<15|o>>>17)+n|0,e+=(n^(o|~r))+h[5]-57434055|0,e=(e<<21|e>>>11)+o|0,r+=(o^(e|~n))+h[12]+1700485571|0,r=(r<<6|r>>>26)+e|0,n+=(e^(r|~o))+h[3]-1894986606|0,n=(n<<10|n>>>22)+r|0,o+=(r^(n|~e))+h[10]-1051523|0,o=(o<<15|o>>>17)+n|0,e+=(n^(o|~r))+h[1]-2054922799|0,e=(e<<21|e>>>11)+o|0,r+=(o^(e|~n))+h[8]+1873313359|0,r=(r<<6|r>>>26)+e|0,n+=(e^(r|~o))+h[15]-30611744|0,n=(n<<10|n>>>22)+r|0,o+=(r^(n|~e))+h[6]-1560198380|0,o=(o<<15|o>>>17)+n|0,e+=(n^(o|~r))+h[13]+1309151649|0,e=(e<<21|e>>>11)+o|0,r+=(o^(e|~n))+h[4]-145523070|0,r=(r<<6|r>>>26)+e|0,n+=(e^(r|~o))+h[11]-1120210379|0,n=(n<<10|n>>>22)+r|0,o+=(r^(n|~e))+h[2]+718787259|0,o=(o<<15|o>>>17)+n|0,e+=(n^(o|~r))+h[9]-343485551|0,e=(e<<21|e>>>11)+o|0,u[0]=r+u[0]|0,u[1]=e+u[1]|0,u[2]=o+u[2]|0,u[3]=n+u[3]|0}function l(u){var h=[],r;for(r=0;r<64;r+=4)h[r>>2]=u.charCodeAt(r)+(u.charCodeAt(r+1)<<8)+(u.charCodeAt(r+2)<<16)+(u.charCodeAt(r+3)<<24);return h}function f(u){var h=[],r;for(r=0;r<64;r+=4)h[r>>2]=u[r]+(u[r+1]<<8)+(u[r+2]<<16)+(u[r+3]<<24);return h}function d(u){var h=u.length,r=[1732584193,-271733879,-1732584194,271733878],e,o,n,S,D,R;for(e=64;e<=h;e+=64)c(r,l(u.substring(e-64,e)));for(u=u.substring(e-64),o=u.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<o;e+=1)n[e>>2]|=u.charCodeAt(e)<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(c(r,n),e=0;e<16;e+=1)n[e]=0;return S=h*8,S=S.toString(16).match(/(.*?)(.{0,8})$/),D=parseInt(S[2],16),R=parseInt(S[1],16)||0,n[14]=D,n[15]=R,c(r,n),r}function p(u){var h=u.length,r=[1732584193,-271733879,-1732584194,271733878],e,o,n,S,D,R;for(e=64;e<=h;e+=64)c(r,f(u.subarray(e-64,e)));for(u=e-64<h?u.subarray(e-64):new Uint8Array(0),o=u.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<o;e+=1)n[e>>2]|=u[e]<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(c(r,n),e=0;e<16;e+=1)n[e]=0;return S=h*8,S=S.toString(16).match(/(.*?)(.{0,8})$/),D=parseInt(S[2],16),R=parseInt(S[1],16)||0,n[14]=D,n[15]=R,c(r,n),r}function g(u){var h="",r;for(r=0;r<4;r+=1)h+=s[u>>r*8+4&15]+s[u>>r*8&15];return h}function m(u){var h;for(h=0;h<u.length;h+=1)u[h]=g(u[h]);return u.join("")}m(d("hello"))!=="5d41402abc4b2a76b9719d911017c592"&&(t=function(u,h){var r=(u&65535)+(h&65535),e=(u>>16)+(h>>16)+(r>>16);return e<<16|r&65535}),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function u(h,r){return h=h|0||0,h<0?Math.max(h+r,0):Math.min(h,r)}ArrayBuffer.prototype.slice=function(h,r){var e=this.byteLength,o=u(h,e),n=e,S,D,R,K;return r!==a&&(n=u(r,e)),o>n?new ArrayBuffer(0):(S=n-o,D=new ArrayBuffer(S),R=new Uint8Array(D),K=new Uint8Array(this,o,S),R.set(K),D)}}();function w(u){return/[\u0080-\uFFFF]/.test(u)&&(u=unescape(encodeURIComponent(u))),u}function y(u,h){var r=u.length,e=new ArrayBuffer(r),o=new Uint8Array(e),n;for(n=0;n<r;n+=1)o[n]=u.charCodeAt(n);return h?o:e}function _(u){return String.fromCharCode.apply(null,new Uint8Array(u))}function C(u,h,r){var e=new Uint8Array(u.byteLength+h.byteLength);return e.set(new Uint8Array(u)),e.set(new Uint8Array(h),u.byteLength),r?e:e.buffer}function b(u){var h=[],r=u.length,e;for(e=0;e<r-1;e+=2)h.push(parseInt(u.substr(e,2),16));return String.fromCharCode.apply(String,h)}function v(){this.reset()}return v.prototype.append=function(u){return this.appendBinary(w(u)),this},v.prototype.appendBinary=function(u){this._buff+=u,this._length+=u.length;var h=this._buff.length,r;for(r=64;r<=h;r+=64)c(this._hash,l(this._buff.substring(r-64,r)));return this._buff=this._buff.substring(r-64),this},v.prototype.end=function(u){var h=this._buff,r=h.length,e,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n;for(e=0;e<r;e+=1)o[e>>2]|=h.charCodeAt(e)<<(e%4<<3);return this._finish(o,r),n=m(this._hash),u&&(n=b(n)),this.reset(),n},v.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},v.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},v.prototype.setState=function(u){return this._buff=u.buff,this._length=u.length,this._hash=u.hash,this},v.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},v.prototype._finish=function(u,h){var r=h,e,o,n;if(u[r>>2]|=128<<(r%4<<3),r>55)for(c(this._hash,u),r=0;r<16;r+=1)u[r]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(e[2],16),n=parseInt(e[1],16)||0,u[14]=o,u[15]=n,c(this._hash,u)},v.hash=function(u,h){return v.hashBinary(w(u),h)},v.hashBinary=function(u,h){var r=d(u),e=m(r);return h?b(e):e},v.ArrayBuffer=function(){this.reset()},v.ArrayBuffer.prototype.append=function(u){var h=C(this._buff.buffer,u,!0),r=h.length,e;for(this._length+=u.byteLength,e=64;e<=r;e+=64)c(this._hash,f(h.subarray(e-64,e)));return this._buff=e-64<r?new Uint8Array(h.buffer.slice(e-64)):new Uint8Array(0),this},v.ArrayBuffer.prototype.end=function(u){var h=this._buff,r=h.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o,n;for(o=0;o<r;o+=1)e[o>>2]|=h[o]<<(o%4<<3);return this._finish(e,r),n=m(this._hash),u&&(n=b(n)),this.reset(),n},v.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},v.ArrayBuffer.prototype.getState=function(){var u=v.prototype.getState.call(this);return u.buff=_(u.buff),u},v.ArrayBuffer.prototype.setState=function(u){return u.buff=y(u.buff,!0),v.prototype.setState.call(this,u)},v.ArrayBuffer.prototype.destroy=v.prototype.destroy,v.ArrayBuffer.prototype._finish=v.prototype._finish,v.ArrayBuffer.hash=function(u,h){var r=p(new Uint8Array(u)),e=m(r);return h?b(e):e},v})});var k=O(W(),1),yt=32768,tt=async a=>{let t=Math.min(yt,a.size),s=Math.ceil(a.size/t),i=new k.default.ArrayBuffer;for(let c=0;c<s;c++){let f=await a.slice(c*t,(c+1)*t).arrayBuffer();i.append(f)}return i.end(!0)},F=()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,a=>(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16));var $=class{constructor(t,{batchSize:s}){this.db=t,this.batchSize=s,this.onDiff=null,this.onClose=null,this.changes=[]}addChange(t){return this.changes.push(t),this.processDiffs()}close(){return this.processDiffs(!0)}async getDiff(t){return new Promise((s,i)=>{let c=this.db.getDocStore("readonly"),l=[],f=Object.keys(t).length;for(let d in t)c.get(d).onsuccess=p=>{f--;let g=p.target.result;for(let m of t[d])g&&m in g.revs||l.push({id:d,rev:m});f===0&&s(l)}})}async processDiffs(t){if(!t&&this.changes.length<this.batchSize)return;if(this.changes.length===0){t&&this.onClose();return}let s=[];do if(s=this.changes.splice(0,this.batchSize),s.length>0){let i={};for(let{id:l,changes:f}of s)i[l]=f.map(({rev:d})=>d);let c=await this.getDiff(i);for(let l of c)this.onDiff(l)}while(s.length===this.batchSize);t&&this.onClose()}},A=class{constructor(t,{batchSize:s}){let i=new $(t,{batchSize:s}),c=new CountQueuingStrategy({highWaterMark:1});this.readable=new ReadableStream({start(l){i.onDiff=f=>l.enqueue(f),i.onClose=()=>l.close()}}),this.writable=new WritableStream({write(l){return i.addChange(l)},close(){return i.close()}},c)}};var ct=O(W(),1);function st(a){for(var t,s,i,c=a.rev_tree.slice(),l;l=c.pop();){var f=l.ids,d=f[2],p=l.pos;if(d.length){for(var g=0,m=d.length;g<m;g++)c.push({pos:p+1,ids:d[g]});continue}var w=!!f[1].deleted,y=f[0];(!t||(i!==w?i:s!==p?s<p:t<y))&&(t=y,s=p,i=w)}return s+"-"+t}function nt(a,t){for(var s=a.slice(),i;i=s.pop();)for(var c=i.pos,l=i.ids,f=l[2],d=t(f.length===0,c,l[0],i.ctx,l[1]),p=0,g=f.length;p<g;p++)s.push({pos:c+1,ids:f[p],ctx:d})}function ot(a){var t=[];return nt(a.rev_tree,function(s,i,c,l,f){f.status==="available"&&!s&&(t.push(i+"-"+c),f.status="missing")}),t}function bt(a){for(var t=[],s=a.slice(),i;i=s.pop();){var c=i.pos,l=i.ids,f=l[0],d=l[1],p=l[2],g=p.length===0,m=i.history?i.history.slice():[];m.push({id:f,opts:d}),g&&t.push({pos:c+1-m.length,ids:m});for(var w=0,y=p.length;w<y;w++)s.push({pos:c+1,ids:p[w],history:m})}return t.reverse()}function St(a,t){return a.pos-t.pos}function _t(a,t,s){for(var i=0,c=a.length,l;i<c;)l=i+c>>>1,s(a[l],t)<0?i=l+1:c=l;return i}function Ct(a,t,s){var i=_t(a,t,s);a.splice(i,0,t)}function et(a,t){for(var s,i,c=t,l=a.length;c<l;c++){var f=a[c],d=[f.id,f.opts,[]];i?(i[2].push(d),i=d):s=i=d}return s}function Dt(a,t){return a[0]<t[0]?-1:1}function rt(a,t){for(var s=[{tree1:a,tree2:t}],i=!1;s.length>0;){var c=s.pop(),l=c.tree1,f=c.tree2;(l[1].status||f[1].status)&&(l[1].status=l[1].status==="available"||f[1].status==="available"?"available":"missing");for(var d=0;d<f[2].length;d++){if(!l[2][0]){i="new_leaf",l[2][0]=f[2][d];continue}for(var p=!1,g=0;g<l[2].length;g++)l[2][g][0]===f[2][d][0]&&(s.push({tree1:l[2][g],tree2:f[2][d]}),p=!0);p||(i="new_branch",Ct(l[2],f[2][d],Dt))}}return{conflicts:i,tree:a}}function it(a,t,s){var i=[],c=!1,l=!1,f;if(!a.length)return{tree:[t],conflicts:"new_leaf"};for(var d=0,p=a.length;d<p;d++){var g=a[d];if(g.pos===t.pos&&g.ids[0]===t.ids[0])f=rt(g.ids,t.ids),i.push({pos:g.pos,ids:f.tree}),c=c||f.conflicts,l=!0;else if(s!==!0){var m=g.pos<t.pos?g:t,w=g.pos<t.pos?t:g,y=w.pos-m.pos,_=[],C=[];for(C.push({ids:m.ids,diff:y,parent:null,parentIdx:null});C.length>0;){var b=C.pop();if(b.diff===0){b.ids[0]===w.ids[0]&&_.push(b);continue}for(var v=b.ids[2],u=0,h=v.length;u<h;u++)C.push({ids:v[u],diff:b.diff-1,parent:b.ids,parentIdx:u})}var r=_[0];r?(f=rt(r.ids,w.ids),r.parent[2][r.parentIdx]=f.tree,i.push({pos:m.pos,ids:m.ids}),c=c||f.conflicts,l=!0):i.push(g)}else i.push(g)}return l||i.push(t),i.sort(St),{tree:i,conflicts:c||"internal_node"}}function Rt(a,t){for(var s=bt(a),i,c,l=0,f=s.length;l<f;l++){var d=s[l],p=d.ids,g;if(p.length>t){i||(i={});var m=p.length-t;g={pos:d.pos+m,ids:et(p,m)};for(var w=0;w<m;w++){var y=d.pos+w+"-"+p[w].id;i[y]=!0}}else g={pos:d.pos,ids:et(p,0)};c?c=it(c,g,!0).tree:c=[g]}return i&&nt(c,function(_,C,b){delete i[C+"-"+b]}),{tree:c,revs:i?Object.keys(i):[]}}function at(a,t,s){var i=it(a,t),c=Rt(i.tree,s);return{tree:c.tree,stemmedRevs:c.revs,conflicts:i.conflicts}}var Tt=1e3,N={status:"available"},ht={status:"missing"},At=a=>{let[t,s]=a.split("-");return[parseInt(t,10),s]},Pt=a=>{let t=a.start-a.ids.length+1,s=a.ids,i=[s[0],N,[]];for(let c=1,l=s.length;c<l;c++)i=[s[c],ht,[i]];return[{pos:t,ids:i}]},Bt=async a=>{let t=await tt(a);return`md5-${btoa(t)}`},Et=a=>{let t={};for(let i in a)i!=="_revisions"&&(t[i]=a[i]);let s=JSON.stringify(t);return ct.default.hash(s)},qt=async(a,t,s)=>{if(!a)return t;for(let i in a){let c=a[i],{stub:l}=c;if(l){let{digest:f}=c;t[f].revs[s]=!0}else{let{content_type:f,data:d}=c;if(typeof d=="string")throw new Error("Base64 attachments are not supported");let p=c.digest||await Bt(d);c.digest=p,c.revpos=parseInt(s,10),t[p]={data:d,revs:{[s]:!0}}}}return t},Ut=a=>{let t={};for(let s in a)s.startsWith("_")||(t[s]=a[s]);if(a._attachments){t._attachments={};for(let s in a._attachments){let{digest:i,revpos:c}=a._attachments[s];t._attachments[s]={digest:i,revpos:c}}}return t},ut=async(a,t,s,{newEdits:i}={newEdits:!0})=>{let c;if(i){let o=await Et(t),n;if(t._rev){let[S,D]=At(t._rev);n=S+1,c=[{pos:S,ids:[D,ht,[[o,N,[]]]]}]}else n=1,c=[{pos:1,ids:[o,N,[]]}];t._rev=`${n}-${o}`}else c=Pt(t._revisions);let{_id:l,_rev:f,_deleted:d,_attachments:p}=t,g=s?s.attachments:{},m=await qt(p,g,f),w=Ut(t),y=s?s.rev_tree:[],{tree:_,stemmedRevs:C}=at(y,c[0],Tt),b=st({rev_tree:_}),u={...s?s.revs:null,[f]:{data:w,deleted:!!d}},h=u[b].deleted,e=ot({rev_tree:_}).concat(C);for(let o of e)delete u[o];return{attachments:m,deleted:h,id:l,rev:b,rev_tree:_,revs:u,seq:a}};var j=class{constructor(t,{batchSize:s}){this.db=t,this.batchSize=s,this.docs=[],this.docsWritten=0}add(t){return this.docs.push(t),this.processBatch()}close(){return this.processBatch(!0)}async getExistingEntries(t){return new Promise((s,i)=>{let c=this.db.getDocStore("readonly"),l=t.length,f=[];for(let d of t){let p={doc:d};c.get(d._id).onsuccess=async g=>{l--,p.existingEntry=g.target.result,f.push(p),l===0&&s(f)}}})}async buildEntries(t,s){let i=[];for(let{doc:c,existingEntry:l}of t){let f=++s.seq,d=await ut(f,c,l,{newEdits:!1}),p,{deleted:g}=d;l?l.deleted?p=g?0:1:p=g?-1:0:p=g?0:1,s.doc_count+=p,i.push(d)}return{entries:i,metadata:s}}async saveEntries(t,{seq:s,doc_count:i}){return new Promise((c,l)=>{let{docStore:f,metaStore:d}=this.db.getStores("readwrite"),p=t.length;for(let g of t)f.put(g).onsuccess=()=>{this.docsWritten++,p--,p===0&&(this.db.metadata.seq=s,this.db.metadata.doc_count=i,d.put(this.db.metadata).onsuccess=()=>c())}})}async saveDocs(t){let s={docsWritten:0},i=await this.getExistingEntries(t),{seq:c,doc_count:l}=this.db.metadata,{entries:f,metadata:d}=await this.buildEntries(i,{seq:c,doc_count:l});return this.saveEntries(f,d)}async processBatch(t){if(!t&&this.docs.length<this.batchSize||this.docs.length===0)return;let s=[];do s=this.docs.splice(0,this.batchSize),s.length>0&&await this.saveDocs(s);while(s.length===this.batchSize)}},P=class{constructor(t,{batchSize:s}){this.docsWriter=new j(t,{batchSize:s})}get docsWritten(){return this.docsWriter.docsWritten}write(t){return this.docsWriter.add(t)}close(){return this.docsWriter.close()}};var B="docs",T="meta",E=class{constructor({name:t}){this.name=t,this.db=null,this.metadata=null}async init(){if(!this.db)return new Promise((t,s)=>{let i=indexedDB.open(this.name);i.onupgradeneeded=c=>{let l=c.target.result,f="id";l.createObjectStore(B,{keyPath:f}).createIndex("seq","seq",{unique:!0}),l.createObjectStore(T,{keyPath:f})},i.onsuccess=c=>{this.db=c.target.result,this.db.onabort=()=>this.db.close(),this.db.onversionchange=()=>this.db.close();let l=this.db.transaction(T,"readwrite");l.oncomplete=()=>t();let f=l.objectStore(T);f.get(T).onsuccess=d=>{this.metadata=d.target.result||{id:T};let p=!1;"doc_count"in this.metadata||(p=!0,this.metadata.doc_count=0),"seq"in this.metadata||(p=!0,this.metadata.seq=0),"db_uuid"in this.metadata||(p=!0,this.metadata.db_uuid=F()),p&&f.put(this.metadata)}},i.onerror=c=>s(c.target.error),i.onblocked=c=>s(c)})}getDocStore(t){return this.db.transaction(B,t).objectStore(B)}getStores(t){let s=this.db.transaction([B,T],t);return{docStore:s.objectStore(B),metaStore:s.objectStore(T)}}destroy(){return new Promise((t,s)=>{this.db.close();let i=indexedDB.deleteDatabase(this.name);i.onsuccess=()=>{this.db=null,this.metadata=null,t()}})}getUuid(){let{db_uuid:t}=this.metadata;return t}getUpdateSeq(){let{seq:t}=this.metadata;return t}async getReplicationLog(t){let s=`_local/${t}`;return new Promise((i,c)=>{this.getDocStore("readonly").get(s).onsuccess=l=>{let f=l.target.result,d=f?f.data:{_id:s};i(d)}})}async saveReplicationLog(t){return t._rev=t._rev?t._rev+1:1,new Promise((s,i)=>{let c={id:t._id,data:t};this.getDocStore("readwrite").put(c).onsuccess=()=>s({rev:t._rev})})}async getChangesStream(t,{limit:s}={}){throw new Error("Not supported for Local yet")}get lastSeq(){throw new Error("Not supported for Local yet")}getDiffsStream({batchSize:t}={batchSize:128}){return new A(this,{batchSize:t})}getDocsStream({batchSize:t}={batchSize:512}){throw new Error("Not supported for Local yet")}get docsRead(){throw new Error("Not supported for Local yet")}writeDocsStream({batchSize:t}={batchSize:128}){this.saveStream=new P(this,{batchSize:t});let s=new CountQueuingStrategy({highWaterMark:1});return new WritableStream(this.saveStream,s)}get docsWritten(){return this.saveStream&&this.saveStream.docsWritten}};var xt=(a,t=0)=>{if(t>a.length+4)return[-1];for(let s=t;s<a.length;s++){if(a[s]===125&&a[s+1]===44&&a[s+2]===13&&a[s+3]===10&&a[s+4]===123)return[s];if(a[s]===10&&a[s+1]===93&&a[s+2]===44)return[s,!0]}return[-1]},V=class{constructor(){this.data=new Uint8Array(0),this.onChange=null,this.onClose=null,this.decoder=new TextDecoder,this.startParsed=!1,this.lastSeq=null,this.numberOfChanges=0}addBinaryData(t){let s=new Uint8Array(this.data.length+t.length);s.set(this.data,0),s.set(t,this.data.length),this.data=s,this.checkforChanges()}checkforChanges(){this.startParsed||(this.data=this.data.slice(13),this.startParsed=!0);let t;do{t=null;let[s,i]=xt(this.data);if(s!==-1){if(s>0){let c=this.decoder.decode(this.data.slice(0,s+1));t=JSON.parse(c),this.onChange(t),this.numberOfChanges++}if(i){let c=this.decoder.decode(this.data.slice(s+4)),{last_seq:l}=JSON.parse(`{${c}`);return this.lastSeq=l,this.onClose()}this.data=this.data.slice(s+4)}}while(t)}},q=class{constructor(){let t=new V,s=new CountQueuingStrategy({highWaterMark:1});this.readable=new ReadableStream({start(i){t.onChange=c=>i.enqueue(c),t.onClose=()=>i.close()}}),this.writable=new WritableStream({write(i){t.addBinaryData(i)}},s),this.unpacker=t}get lastSeq(){return this.unpacker.lastSeq}get numberOfChanges(){return this.unpacker.numberOfChanges}};function U(a,t,s=0){if(s>a.length+t.length+2)return-1;for(let i=s;i<a.length;i++)if(a[i]===45&&a[i+1]===45){let c,l;for(l=0;l<t.length;l++)if(c=!0,a[l+i+2]!==t[l]){c=!1;break}if(c)return i}return-1}function J(a,t=0){if(t>a.length+4)return-1;for(let s=t;s<a.length;s++)if(a[s]===13&&a[s+1]===10&&a[s+2]===13&&a[s+3]===10)return s;return-1}function G(a,t,s=0){if(s>a.length+t.length+4||a[s]!==45||a[s+1]!==45||a[s+t.length+2]!==45||a[s+t.length+3]!==45)return!1;for(let i=0;i<t.length;i++)if(a[i+s+2]!==t[i])return!1;return!0}var x=class{constructor(t){this.encoder=new TextEncoder,this.decoder=new TextDecoder;let s=this.parseContentType(t);this.id=s.id,this.boundaries=[s]}parseContentType(t){let[s,i,c]=t.match(/^([^;]+);\s*boundary="?([^="]+)"?/)||[];if(i!=="multipart/related")return;let l=this.encoder.encode(c);return{id:c,boundary:l}}parsePart(t){if(this.boundaries.length===0)return null;let{id:s,boundary:i}=this.boundaries[this.boundaries.length-1],c=U(t,i);if(c===-1)return null;let l=J(t,c);if(l===-1)return null;let f=t.slice(i.length+4,l),p=this.decoder.decode(f).split(`\r
`).reduce((u,h)=>{let[r,e]=h.split(/:\s*/);return u[r]=r==="Content-Length"?parseInt(e,10):e,u},{}),{"Content-Type":g}=p;if(!g)return null;let{"Content-Length":m}=p,w=m?U(t,i,m+l+6):U(t,i,l+4);if(w===-1||t.length<w)return null;let y=this.parseContentType(g);if(y)return this.boundaries.push(y),this.parsePart(t.slice(l+4));let _=G(t,i,w),C=_?w+i.length+6:w;_&&this.boundaries.pop();let b=t.slice(l+4,w-2),v=t.slice(C);return{boundary:this.id===s?null:s,headers:p,data:b,rest:v}}};var I=class{constructor(t){this.parser=new x(t),this.data=new Uint8Array(0)}read(t){if(t){let c=new Uint8Array(this.data.length+t.length);c.set(this.data,0),c.set(t,this.data.length),this.data=c}let s=[],i;do if(i=this.parser.parsePart(this.data),i){let{boundary:c,headers:l,data:f,rest:d}=i;this.data=d,s.push({boundary:c,headers:l,data:f})}while(i);return s}};var It=(a,t)=>{let s=new DecompressionStream("gzip"),i=a.stream().pipeThrough(s),c={headers:{"Content-Type":t}};return new Response(i,c).blob()},H=class{constructor(t,{batchSize:s}){this.db=t,this.batchSize=s,this.decoder=new TextDecoder,this.onDoc=null,this.onClose=null,this.revs=[],this.docsRead=0}addRev(t){return this.revs.push(t),this.getDocs()}close(){return this.getDocs(!0)}async getDocs(t){if(!t&&this.revs.length<this.batchSize)return;if(this.revs.length===0){t&&this.onClose();return}let s=[];do s=this.revs.splice(0,this.batchSize),s.length>0&&await this.processBatch(s);while(s.length===this.batchSize);t&&this.onClose()}async processBatch(t){let s=await this.getDocsMultipart(t),i=s.headers.get("Content-Type"),c=new I(i),l=s.body.getReader(),f=!1,d=[],p=null;do{let{done:g,value:m}=await l.read(),w=c.read(m);for(let y of w)y.boundary?p&&p!==y.boundary?(await this.emitDoc(d),d=[y],p=null):(d.push(y),p=y.boundary):(await this.emitDoc(d),d=[],p=null,await this.emitDoc([y]));f=g}while(!f);await this.emitDoc(d)}async getDocsMultipart(t){let s=new URL(`${this.db.root}/_bulk_get`,this.db.url);s.searchParams.set("revs","true"),s.searchParams.set("attachments","true");let i={docs:t},c=await fetch(s,{headers:{...this.db.headers,"Content-Type":"application/json",Accept:"multipart/related"},method:"post",body:JSON.stringify(i)});if(c.status!==200)throw new Error("Could not get docs multipart");return c}async emitDoc(t){if(t.length===0)return;let{headers:s,data:i}=t.shift(),c=this.decoder.decode(i),l=JSON.parse(c);for(let{headers:f,data:d}of t){let p=f["Content-Disposition"];if(!p){console.warn("skipping attachment with missing Content-Disposition header",f,l,t);continue}let[g,m]=p.match(/filename="([^"]+)"/);if(!(m in l._attachments)){console.warn("skipping attachment due to missing filename in docs attachments stub",f,l,t);continue}let w=f["Content-Type"];if(!w){console.warn("skipping attachment due to missing Content-Type header",f,l,t);continue}let y=new Blob([d],{type:w}),_=f["Content-Encoding"];if(_==="gzip")l._attachments[m].data=await It(y,w),delete l._attachments[m].follows,delete l._attachments[m].encoding,delete l._attachments[m].encoded_length;else if(_){console.warn("skipping attachment with unsupported Content-Encoding header",f,l,t);continue}else l._attachments[m].data=y,delete l._attachments[m].follows}this.docsRead++,this.onDoc(l)}},L=class{constructor(t,{batchSize:s}){let i=new H(t,{batchSize:s}),c=new CountQueuingStrategy({highWaterMark:1});this.docsGetter=i,this.readable=new ReadableStream({start(l){i.onDoc=f=>l.enqueue(f),i.onClose=()=>l.close()}}),this.writable=new WritableStream({write(l){return i.addRev(l)},close(){return i.close()}},c)}get docsRead(){return this.docsGetter.docsRead}};var z=class{constructor({url:t,headers:s}){this.url=t,this.root=t.pathname,this.headers=s,this.changesParser=null}async getUuid(){let t=new URL(this.url);t.pathname="/";let s=await fetch(t,{headers:this.headers});if(s.status!==200)throw new Error("Remote server not reachable");let{uuid:i}=await s.json();return i}async getUpdateSeq(){let t=new URL(this.url),s=await fetch(t,{headers:this.headers});if(s.status!==200)throw new Error("Remote database not reachable");let{update_seq:i}=await s.json();return i}async getReplicationLog(t){let s=`_local/${t}`,i=new URL(`${this.root}/${s}`,this.url),c=await fetch(i,{headers:this.headers});return c.status===200?c.json():{_id:s}}async saveReplicationLog(t){let s=new URL(`${this.root}/${t._id}`,this.url),i=await fetch(s,{headers:{...this.headers,"Content-Type":"application/json"},method:"put",body:JSON.stringify(t)});if(i.status!==201)throw new Error("Could not save replication log");return i.json()}async getChangesStream(t,{limit:s}={}){let i=new URL(`${this.root}/_changes`,this.url);i.searchParams.set("feed","normal"),i.searchParams.set("style","all_docs"),t&&i.searchParams.set("since",t),s&&(i.searchParams.set("limit",s),i.searchParams.set("seq_interval",s));let c=await fetch(i,{headers:this.headers});if(c.status!==200)throw new Error("Could not get changes");this.changesParserTransformStream=new q;let l=c.body.getReader();return new ReadableStream({async start(d){for(;;){let{done:p,value:g}=await l.read();if(p)break;d.enqueue(g)}d.close(),l.releaseLock()}}).pipeThrough(this.changesParserTransformStream)}get lastSeq(){return this.changesParserTransformStream&&this.changesParserTransformStream.lastSeq}get numberOfChanges(){return this.changesParserTransformStream&&this.changesParserTransformStream.numberOfChanges}getDiffsStream({batchSize:t}={batchSize:128}){throw new Error("Not supported for Remote yet")}getDocsStream({batchSize:t}={batchSize:512}){return this.getDocsTransformSteam=new L(this,{batchSize:t}),this.getDocsTransformSteam}get docsRead(){return this.getDocsTransformSteam?this.getDocsTransformSteam.docsRead:0}writeDocsStream({batchSize:t}={batchSize:128}){throw new Error("Not supported for Remote yet")}get docsWritten(){throw new Error("Not supported for Remote yet")}};var lt=O(W(),1);var Lt=async(a,t)=>lt.default.hash(`${a}${t}`),zt=(a,t)=>a.session_id&&a.session_id===t.session_id&&a.source_last_seq&&a.source_last_seq===t.source_last_seq?a.source_last_seq:null,Wt=(a,t)=>{if(!a)return-1;if(!t)return 1;if(a===t)return 0;let s=parseInt(a,10),i=parseInt(t,10);return s-i};async function M(a,t){let s=F(),i={docsRead:0,docsWritten:0},[c,l,f]=await Promise.all([t.getUuid(),a.getUuid(),a.getUpdateSeq()]),d=await Lt(c,l),[p,g]=await Promise.all([t.getReplicationLog(d),a.getReplicationLog(d)]),m=zt(p,g),w=!1;for(;!w&&Wt(m,f)<0;){await a.getChangesStream(m,{limit:1024}).then(v=>v.pipeThrough(t.getDiffsStream({batchSize:128}))).then(v=>v.pipeThrough(a.getDocsStream({batchSize:512}))).then(v=>v.pipeTo(t.writeDocsStream({batchSize:128})));let{lastSeq:y,numberOfChanges:_,docsRead:C}=a,{docsWritten:b}=t;if(i.lastSeq=y,i.docsRead+=C,i.docsWritten+=b,w=_<1024,y!==m){g.session_id=s,g.source_last_seq=y,p.session_id=s,p.source_last_seq=y;let[{rev:v},{rev:u}]=await Promise.all([t.saveReplicationLog(p),a.saveReplicationLog(g)]);p._rev=v,g._rev=u}m=y}return i}var Ft=new Event("change"),Q=class extends EventTarget{constructor({name:t,url:s,headers:i}){super(),this.local=new E({name:t}),this.remote=new z({url:s,headers:i})}init(){return this.local.init()}async pull(){console.time("pull");let t=await M(this.remote,this.local);return console.timeEnd("pull"),t.docsWritten>0&&this.dispatchEvent(Ft),t}push(){return M(this.local,this.remote)}sync(){return Promise.all([this.pull(),this.push()])}};export{Q as default};
