var vt=Object.create;var k=Object.defineProperty;var mt=Object.getOwnPropertyDescriptor;var yt=Object.getOwnPropertyNames;var wt=Object.getPrototypeOf,_t=Object.prototype.hasOwnProperty;var bt=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var St=(i,t,n,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let c of yt(t))!_t.call(i,c)&&c!==n&&k(i,c,{get:()=>t[c],enumerable:!(a=mt(t,c))||a.enumerable});return i};var O=(i,t,n)=>(n=i!=null?vt(wt(i)):{},St(t||!i||!i.__esModule?k(n,"default",{value:i,enumerable:!0}):n,i));var I=bt((tt,et)=>{(function(i){if(typeof tt=="object")et.exports=i();else if(typeof define=="function"&&define.amd)define(i);else{var t;try{t=window}catch{t=self}t.SparkMD5=i()}})(function(i){"use strict";var t=function(h,u){return h+u&4294967295},n=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function a(h,u,r,e,o,s){return u=t(t(u,h),t(e,s)),t(u<<o|u>>>32-o,r)}function c(h,u){var r=h[0],e=h[1],o=h[2],s=h[3];r+=(e&o|~e&s)+u[0]-680876936|0,r=(r<<7|r>>>25)+e|0,s+=(r&e|~r&o)+u[1]-389564586|0,s=(s<<12|s>>>20)+r|0,o+=(s&r|~s&e)+u[2]+606105819|0,o=(o<<17|o>>>15)+s|0,e+=(o&s|~o&r)+u[3]-1044525330|0,e=(e<<22|e>>>10)+o|0,r+=(e&o|~e&s)+u[4]-176418897|0,r=(r<<7|r>>>25)+e|0,s+=(r&e|~r&o)+u[5]+1200080426|0,s=(s<<12|s>>>20)+r|0,o+=(s&r|~s&e)+u[6]-1473231341|0,o=(o<<17|o>>>15)+s|0,e+=(o&s|~o&r)+u[7]-45705983|0,e=(e<<22|e>>>10)+o|0,r+=(e&o|~e&s)+u[8]+1770035416|0,r=(r<<7|r>>>25)+e|0,s+=(r&e|~r&o)+u[9]-1958414417|0,s=(s<<12|s>>>20)+r|0,o+=(s&r|~s&e)+u[10]-42063|0,o=(o<<17|o>>>15)+s|0,e+=(o&s|~o&r)+u[11]-1990404162|0,e=(e<<22|e>>>10)+o|0,r+=(e&o|~e&s)+u[12]+1804603682|0,r=(r<<7|r>>>25)+e|0,s+=(r&e|~r&o)+u[13]-40341101|0,s=(s<<12|s>>>20)+r|0,o+=(s&r|~s&e)+u[14]-1502002290|0,o=(o<<17|o>>>15)+s|0,e+=(o&s|~o&r)+u[15]+1236535329|0,e=(e<<22|e>>>10)+o|0,r+=(e&s|o&~s)+u[1]-165796510|0,r=(r<<5|r>>>27)+e|0,s+=(r&o|e&~o)+u[6]-1069501632|0,s=(s<<9|s>>>23)+r|0,o+=(s&e|r&~e)+u[11]+643717713|0,o=(o<<14|o>>>18)+s|0,e+=(o&r|s&~r)+u[0]-373897302|0,e=(e<<20|e>>>12)+o|0,r+=(e&s|o&~s)+u[5]-701558691|0,r=(r<<5|r>>>27)+e|0,s+=(r&o|e&~o)+u[10]+38016083|0,s=(s<<9|s>>>23)+r|0,o+=(s&e|r&~e)+u[15]-660478335|0,o=(o<<14|o>>>18)+s|0,e+=(o&r|s&~r)+u[4]-405537848|0,e=(e<<20|e>>>12)+o|0,r+=(e&s|o&~s)+u[9]+568446438|0,r=(r<<5|r>>>27)+e|0,s+=(r&o|e&~o)+u[14]-1019803690|0,s=(s<<9|s>>>23)+r|0,o+=(s&e|r&~e)+u[3]-187363961|0,o=(o<<14|o>>>18)+s|0,e+=(o&r|s&~r)+u[8]+1163531501|0,e=(e<<20|e>>>12)+o|0,r+=(e&s|o&~s)+u[13]-1444681467|0,r=(r<<5|r>>>27)+e|0,s+=(r&o|e&~o)+u[2]-51403784|0,s=(s<<9|s>>>23)+r|0,o+=(s&e|r&~e)+u[7]+1735328473|0,o=(o<<14|o>>>18)+s|0,e+=(o&r|s&~r)+u[12]-1926607734|0,e=(e<<20|e>>>12)+o|0,r+=(e^o^s)+u[5]-378558|0,r=(r<<4|r>>>28)+e|0,s+=(r^e^o)+u[8]-2022574463|0,s=(s<<11|s>>>21)+r|0,o+=(s^r^e)+u[11]+1839030562|0,o=(o<<16|o>>>16)+s|0,e+=(o^s^r)+u[14]-35309556|0,e=(e<<23|e>>>9)+o|0,r+=(e^o^s)+u[1]-1530992060|0,r=(r<<4|r>>>28)+e|0,s+=(r^e^o)+u[4]+1272893353|0,s=(s<<11|s>>>21)+r|0,o+=(s^r^e)+u[7]-155497632|0,o=(o<<16|o>>>16)+s|0,e+=(o^s^r)+u[10]-1094730640|0,e=(e<<23|e>>>9)+o|0,r+=(e^o^s)+u[13]+681279174|0,r=(r<<4|r>>>28)+e|0,s+=(r^e^o)+u[0]-358537222|0,s=(s<<11|s>>>21)+r|0,o+=(s^r^e)+u[3]-722521979|0,o=(o<<16|o>>>16)+s|0,e+=(o^s^r)+u[6]+76029189|0,e=(e<<23|e>>>9)+o|0,r+=(e^o^s)+u[9]-640364487|0,r=(r<<4|r>>>28)+e|0,s+=(r^e^o)+u[12]-421815835|0,s=(s<<11|s>>>21)+r|0,o+=(s^r^e)+u[15]+530742520|0,o=(o<<16|o>>>16)+s|0,e+=(o^s^r)+u[2]-995338651|0,e=(e<<23|e>>>9)+o|0,r+=(o^(e|~s))+u[0]-198630844|0,r=(r<<6|r>>>26)+e|0,s+=(e^(r|~o))+u[7]+1126891415|0,s=(s<<10|s>>>22)+r|0,o+=(r^(s|~e))+u[14]-1416354905|0,o=(o<<15|o>>>17)+s|0,e+=(s^(o|~r))+u[5]-57434055|0,e=(e<<21|e>>>11)+o|0,r+=(o^(e|~s))+u[12]+1700485571|0,r=(r<<6|r>>>26)+e|0,s+=(e^(r|~o))+u[3]-1894986606|0,s=(s<<10|s>>>22)+r|0,o+=(r^(s|~e))+u[10]-1051523|0,o=(o<<15|o>>>17)+s|0,e+=(s^(o|~r))+u[1]-2054922799|0,e=(e<<21|e>>>11)+o|0,r+=(o^(e|~s))+u[8]+1873313359|0,r=(r<<6|r>>>26)+e|0,s+=(e^(r|~o))+u[15]-30611744|0,s=(s<<10|s>>>22)+r|0,o+=(r^(s|~e))+u[6]-1560198380|0,o=(o<<15|o>>>17)+s|0,e+=(s^(o|~r))+u[13]+1309151649|0,e=(e<<21|e>>>11)+o|0,r+=(o^(e|~s))+u[4]-145523070|0,r=(r<<6|r>>>26)+e|0,s+=(e^(r|~o))+u[11]-1120210379|0,s=(s<<10|s>>>22)+r|0,o+=(r^(s|~e))+u[2]+718787259|0,o=(o<<15|o>>>17)+s|0,e+=(s^(o|~r))+u[9]-343485551|0,e=(e<<21|e>>>11)+o|0,h[0]=r+h[0]|0,h[1]=e+h[1]|0,h[2]=o+h[2]|0,h[3]=s+h[3]|0}function f(h){var u=[],r;for(r=0;r<64;r+=4)u[r>>2]=h.charCodeAt(r)+(h.charCodeAt(r+1)<<8)+(h.charCodeAt(r+2)<<16)+(h.charCodeAt(r+3)<<24);return u}function l(h){var u=[],r;for(r=0;r<64;r+=4)u[r>>2]=h[r]+(h[r+1]<<8)+(h[r+2]<<16)+(h[r+3]<<24);return u}function d(h){var u=h.length,r=[1732584193,-271733879,-1732584194,271733878],e,o,s,S,T,D;for(e=64;e<=u;e+=64)c(r,f(h.substring(e-64,e)));for(h=h.substring(e-64),o=h.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<o;e+=1)s[e>>2]|=h.charCodeAt(e)<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(c(r,s),e=0;e<16;e+=1)s[e]=0;return S=u*8,S=S.toString(16).match(/(.*?)(.{0,8})$/),T=parseInt(S[2],16),D=parseInt(S[1],16)||0,s[14]=T,s[15]=D,c(r,s),r}function p(h){var u=h.length,r=[1732584193,-271733879,-1732584194,271733878],e,o,s,S,T,D;for(e=64;e<=u;e+=64)c(r,l(h.subarray(e-64,e)));for(h=e-64<u?h.subarray(e-64):new Uint8Array(0),o=h.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<o;e+=1)s[e>>2]|=h[e]<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(c(r,s),e=0;e<16;e+=1)s[e]=0;return S=u*8,S=S.toString(16).match(/(.*?)(.{0,8})$/),T=parseInt(S[2],16),D=parseInt(S[1],16)||0,s[14]=T,s[15]=D,c(r,s),r}function g(h){var u="",r;for(r=0;r<4;r+=1)u+=n[h>>r*8+4&15]+n[h>>r*8&15];return u}function v(h){var u;for(u=0;u<h.length;u+=1)h[u]=g(h[u]);return h.join("")}v(d("hello"))!=="5d41402abc4b2a76b9719d911017c592"&&(t=function(h,u){var r=(h&65535)+(u&65535),e=(h>>16)+(u>>16)+(r>>16);return e<<16|r&65535}),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function h(u,r){return u=u|0||0,u<0?Math.max(u+r,0):Math.min(u,r)}ArrayBuffer.prototype.slice=function(u,r){var e=this.byteLength,o=h(u,e),s=e,S,T,D,Y;return r!==i&&(s=h(r,e)),o>s?new ArrayBuffer(0):(S=s-o,T=new ArrayBuffer(S),D=new Uint8Array(T),Y=new Uint8Array(this,o,S),D.set(Y),T)}}();function m(h){return/[\u0080-\uFFFF]/.test(h)&&(h=unescape(encodeURIComponent(h))),h}function b(h,u){var r=h.length,e=new ArrayBuffer(r),o=new Uint8Array(e),s;for(s=0;s<r;s+=1)o[s]=h.charCodeAt(s);return u?o:e}function w(h){return String.fromCharCode.apply(null,new Uint8Array(h))}function R(h,u,r){var e=new Uint8Array(h.byteLength+u.byteLength);return e.set(new Uint8Array(h)),e.set(new Uint8Array(u),h.byteLength),r?e:e.buffer}function _(h){var u=[],r=h.length,e;for(e=0;e<r-1;e+=2)u.push(parseInt(h.substr(e,2),16));return String.fromCharCode.apply(String,u)}function y(){this.reset()}return y.prototype.append=function(h){return this.appendBinary(m(h)),this},y.prototype.appendBinary=function(h){this._buff+=h,this._length+=h.length;var u=this._buff.length,r;for(r=64;r<=u;r+=64)c(this._hash,f(this._buff.substring(r-64,r)));return this._buff=this._buff.substring(r-64),this},y.prototype.end=function(h){var u=this._buff,r=u.length,e,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s;for(e=0;e<r;e+=1)o[e>>2]|=u.charCodeAt(e)<<(e%4<<3);return this._finish(o,r),s=v(this._hash),h&&(s=_(s)),this.reset(),s},y.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},y.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},y.prototype.setState=function(h){return this._buff=h.buff,this._length=h.length,this._hash=h.hash,this},y.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},y.prototype._finish=function(h,u){var r=u,e,o,s;if(h[r>>2]|=128<<(r%4<<3),r>55)for(c(this._hash,h),r=0;r<16;r+=1)h[r]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(e[2],16),s=parseInt(e[1],16)||0,h[14]=o,h[15]=s,c(this._hash,h)},y.hash=function(h,u){return y.hashBinary(m(h),u)},y.hashBinary=function(h,u){var r=d(h),e=v(r);return u?_(e):e},y.ArrayBuffer=function(){this.reset()},y.ArrayBuffer.prototype.append=function(h){var u=R(this._buff.buffer,h,!0),r=u.length,e;for(this._length+=h.byteLength,e=64;e<=r;e+=64)c(this._hash,l(u.subarray(e-64,e)));return this._buff=e-64<r?new Uint8Array(u.buffer.slice(e-64)):new Uint8Array(0),this},y.ArrayBuffer.prototype.end=function(h){var u=this._buff,r=u.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o,s;for(o=0;o<r;o+=1)e[o>>2]|=u[o]<<(o%4<<3);return this._finish(e,r),s=v(this._hash),h&&(s=_(s)),this.reset(),s},y.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},y.ArrayBuffer.prototype.getState=function(){var h=y.prototype.getState.call(this);return h.buff=w(h.buff),h},y.ArrayBuffer.prototype.setState=function(h){return h.buff=b(h.buff,!0),y.prototype.setState.call(this,h)},y.ArrayBuffer.prototype.destroy=y.prototype.destroy,y.ArrayBuffer.prototype._finish=y.prototype._finish,y.ArrayBuffer.hash=function(h,u){var r=p(new Uint8Array(h)),e=v(r);return u?_(e):e},y})});var rt=O(I(),1),Rt=32768,nt=async i=>{let t=Math.min(Rt,i.size),n=Math.ceil(i.size/t),a=new rt.default.ArrayBuffer;for(let c=0;c<n;c++){let l=await i.slice(c*t,(c+1)*t).arrayBuffer();a.append(l)}return a.end(!0)},L=()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,i=>(i^crypto.getRandomValues(new Uint8Array(1))[0]&15>>i/4).toString(16)),A=class extends TransformStream{constructor({batchSize:t}){super({start(){},transform(n,a){if(this.entries.push(n),this.entries.length>=t){let c=this.entries.splice(0,t);a.enqueue(c)}},flush(n){this.entries.length>0&&n.enqueue(this.entries)},entries:[]},{highWaterMark:1},{highWaterMark:1})}};var $=class extends TransformStream{constructor(t){super({start(){},async transform(n,a){let c={};for(let{id:f,changes:l}of n)c[f]=l.map(({rev:d})=>d);return new Promise((f,l)=>{let d=t.getDocStore("readonly"),p=Object.keys(c).length;for(let g in c)d.get(g).onsuccess=v=>{p--;let m=v.target.result;for(let b of c[g])m&&b in m.revs||a.enqueue({id:g,rev:b});p===0&&f()}})},flush(){}})}};function j(i){return new $(i)}var ft=O(I(),1);function it(i){for(var t,n,a,c=i.rev_tree.slice(),f;f=c.pop();){var l=f.ids,d=l[2],p=f.pos;if(d.length){for(var g=0,v=d.length;g<v;g++)c.push({pos:p+1,ids:d[g]});continue}var m=!!l[1].deleted,b=l[0];(!t||(a!==m?a:n!==p?n<p:t<b))&&(t=b,n=p,a=m)}return n+"-"+t}function at(i,t){for(var n=i.slice(),a;a=n.pop();)for(var c=a.pos,f=a.ids,l=f[2],d=t(l.length===0,c,f[0],a.ctx,f[1]),p=0,g=l.length;p<g;p++)n.push({pos:c+1,ids:l[p],ctx:d})}function ct(i){var t=[];return at(i.rev_tree,function(n,a,c,f,l){l.status==="available"&&!n&&(t.push(a+"-"+c),l.status="missing")}),t}function Tt(i){for(var t=[],n=i.slice(),a;a=n.pop();){var c=a.pos,f=a.ids,l=f[0],d=f[1],p=f[2],g=p.length===0,v=a.history?a.history.slice():[];v.push({id:l,opts:d}),g&&t.push({pos:c+1-v.length,ids:v});for(var m=0,b=p.length;m<b;m++)n.push({pos:c+1,ids:p[m],history:v})}return t.reverse()}function Dt(i,t){return i.pos-t.pos}function Ct(i,t,n){for(var a=0,c=i.length,f;a<c;)f=a+c>>>1,n(i[f],t)<0?a=f+1:c=f;return a}function At(i,t,n){var a=Ct(i,t,n);i.splice(a,0,t)}function st(i,t){for(var n,a,c=t,f=i.length;c<f;c++){var l=i[c],d=[l.id,l.opts,[]];a?(a[2].push(d),a=d):n=a=d}return n}function qt(i,t){return i[0]<t[0]?-1:1}function ot(i,t){for(var n=[{tree1:i,tree2:t}],a=!1;n.length>0;){var c=n.pop(),f=c.tree1,l=c.tree2;(f[1].status||l[1].status)&&(f[1].status=f[1].status==="available"||l[1].status==="available"?"available":"missing");for(var d=0;d<l[2].length;d++){if(!f[2][0]){a="new_leaf",f[2][0]=l[2][d];continue}for(var p=!1,g=0;g<f[2].length;g++)f[2][g][0]===l[2][d][0]&&(n.push({tree1:f[2][g],tree2:l[2][d]}),p=!0);p||(a="new_branch",At(f[2],l[2][d],qt))}}return{conflicts:a,tree:i}}function ut(i,t,n){var a=[],c=!1,f=!1,l;if(!i.length)return{tree:[t],conflicts:"new_leaf"};for(var d=0,p=i.length;d<p;d++){var g=i[d];if(g.pos===t.pos&&g.ids[0]===t.ids[0])l=ot(g.ids,t.ids),a.push({pos:g.pos,ids:l.tree}),c=c||l.conflicts,f=!0;else if(n!==!0){var v=g.pos<t.pos?g:t,m=g.pos<t.pos?t:g,b=m.pos-v.pos,w=[],R=[];for(R.push({ids:v.ids,diff:b,parent:null,parentIdx:null});R.length>0;){var _=R.pop();if(_.diff===0){_.ids[0]===m.ids[0]&&w.push(_);continue}for(var y=_.ids[2],h=0,u=y.length;h<u;h++)R.push({ids:y[h],diff:_.diff-1,parent:_.ids,parentIdx:h})}var r=w[0];r?(l=ot(r.ids,m.ids),r.parent[2][r.parentIdx]=l.tree,a.push({pos:v.pos,ids:v.ids}),c=c||l.conflicts,f=!0):a.push(g)}else a.push(g)}return f||a.push(t),a.sort(Dt),{tree:a,conflicts:c||"internal_node"}}function xt(i,t){for(var n=Tt(i),a,c,f=0,l=n.length;f<l;f++){var d=n[f],p=d.ids,g;if(p.length>t){a||(a={});var v=p.length-t;g={pos:d.pos+v,ids:st(p,v)};for(var m=0;m<v;m++){var b=d.pos+m+"-"+p[m].id;a[b]=!0}}else g={pos:d.pos,ids:st(p,0)};c?c=ut(c,g,!0).tree:c=[g]}return a&&at(c,function(w,R,_){delete a[R+"-"+_]}),{tree:c,revs:a?Object.keys(a):[]}}function ht(i,t,n){var a=ut(i,t),c=xt(a.tree,n);return{tree:c.tree,stemmedRevs:c.revs,conflicts:a.conflicts}}var Et=1e3,W={status:"available"},lt={status:"missing"},Pt=i=>{let[t,n]=i.split("-");return[parseInt(t,10),n]},Ut=i=>{let t=i.start-i.ids.length+1,n=i.ids,a=[n[0],W,[]];for(let c=1,f=n.length;c<f;c++)a=[n[c],lt,[a]];return[{pos:t,ids:a}]},Bt=async i=>{let t=await nt(i);return`md5-${btoa(t)}`},It=i=>{let t={};for(let a in i)a!=="_revisions"&&(t[a]=i[a]);let n=JSON.stringify(t);return ft.default.hash(n)},Lt=async(i,t,n)=>{if(!i)return t;for(let a in i){let c=i[a],{stub:f}=c;if(f){let{digest:l}=c;t[l].revs[n]=!0}else{let{content_type:l,data:d}=c;if(typeof d=="string")throw new Error("Base64 attachments are not supported");let p=c.digest||await Bt(d);c.digest=p,c.revpos=parseInt(n,10),t[p]={data:d,revs:{[n]:!0}}}}return t},Ft=i=>{let t={};for(let n in i)n.startsWith("_")||(t[n]=i[n]);if(i._attachments){t._attachments={};for(let n in i._attachments){let{digest:a,revpos:c}=i._attachments[n];t._attachments[n]={digest:a,revpos:c}}}return t},dt=async(i,t,n,{newEdits:a}={newEdits:!0})=>{let c;if(a){let o=await It(t),s;if(t._rev){let[S,T]=Pt(t._rev);s=S+1,c=[{pos:S,ids:[T,lt,[[o,W,[]]]]}]}else s=1,c=[{pos:1,ids:[o,W,[]]}];t._rev=`${s}-${o}`}else c=Ut(t._revisions);let{_id:f,_rev:l,_deleted:d,_attachments:p}=t,g=n?n.attachments:{},v=await Lt(p,g,l),m=Ft(t),b=n?n.rev_tree:[],{tree:w,stemmedRevs:R}=ht(b,c[0],Et),_=it({rev_tree:w}),h={...n?n.revs:null,[l]:{data:m,deleted:!!d}},u=h[_].deleted,e=ct({rev_tree:w}).concat(R);for(let o of e)delete h[o];return{attachments:v,deleted:u,id:f,rev:_,rev_tree:w,revs:h,seq:i}};var N=class{constructor(t){this.db=t,this.docsWritten=0}async getExistingEntries(t){return new Promise((n,a)=>{let c=this.db.getDocStore("readonly"),f=t.length,l=[];for(let d of t){let p={doc:d};c.get(d._id).onsuccess=async g=>{f--,p.existingEntry=g.target.result,l.push(p),f===0&&n(l)}}})}async buildEntries(t,n){let a=[];for(let{doc:c,existingEntry:f}of t){let l=++n.seq,d=await dt(l,c,f,{newEdits:!1}),p,{deleted:g}=d;f?f.deleted?p=g?0:1:p=g?-1:0:p=g?0:1,n.doc_count+=p,a.push(d)}return{entries:a,metadata:n}}async saveEntries(t,{seq:n,doc_count:a}){return new Promise((c,f)=>{let{docStore:l,metaStore:d}=this.db.getStores("readwrite"),p=t.length;for(let g of t)l.put(g).onsuccess=()=>{this.docsWritten++,p--,p===0&&(this.db.metadata.seq=n,this.db.metadata.doc_count=a,d.put(this.db.metadata).onsuccess=()=>c())}})}async saveDocs(t){let n=await this.getExistingEntries(t),{seq:a,doc_count:c}=this.db.metadata,{entries:f,metadata:l}=await this.buildEntries(n,{seq:a,doc_count:c});return this.saveEntries(f,l)}},V=class extends WritableStream{constructor(t,n={}){let a=new N(t);super({write(c){return a.saveDocs(c)},close(){n.docsWritten=a.docsWritten}})}};function z(i,t={}){return new V(i,t)}var q="docs",C="meta",x=class{constructor({name:t}){this.name=t,this.db=null,this.metadata=null}async init(){if(!this.db)return new Promise((t,n)=>{let a=indexedDB.open(this.name);a.onupgradeneeded=c=>{let f=c.target.result,l="id";f.createObjectStore(q,{keyPath:l}).createIndex("seq","seq",{unique:!0}),f.createObjectStore(C,{keyPath:l})},a.onsuccess=c=>{this.db=c.target.result,this.db.onabort=()=>this.db.close(),this.db.onversionchange=()=>this.db.close();let f=this.db.transaction(C,"readwrite");f.oncomplete=()=>t();let l=f.objectStore(C);l.get(C).onsuccess=d=>{this.metadata=d.target.result||{id:C};let p=!1;"doc_count"in this.metadata||(p=!0,this.metadata.doc_count=0),"seq"in this.metadata||(p=!0,this.metadata.seq=0),"db_uuid"in this.metadata||(p=!0,this.metadata.db_uuid=L()),p&&l.put(this.metadata)}},a.onerror=c=>n(c.target.error),a.onblocked=c=>n(c)})}getDocStore(t){return this.db.transaction(q,t).objectStore(q)}getStores(t){let n=this.db.transaction([q,C],t);return{docStore:n.objectStore(q),metaStore:n.objectStore(C)}}destroy(){return new Promise((t,n)=>{this.db.close();let a=indexedDB.deleteDatabase(this.name);a.onsuccess=()=>{this.db=null,this.metadata=null,t()}})}getUuid(){let{db_uuid:t}=this.metadata;return t}getUpdateSeq(){let{seq:t}=this.metadata;return t}async getReplicationLog(t){let n=`_local/${t}`;return new Promise((a,c)=>{this.getDocStore("readonly").get(n).onsuccess=f=>{let l=f.target.result,d=l?l.data:{_id:n};a(d)}})}async saveReplicationLog(t){return t._rev=t._rev?t._rev+1:1,new Promise((n,a)=>{let c={id:t._id,data:t};this.getDocStore("readwrite").put(c).onsuccess=()=>n({rev:t._rev})})}getChanges(t,{limit:n}={},a={}){throw new Error("Not supported for Local yet")}getDiff(){return new j(this)}getDocs(t={}){throw new Error("Not supported for Local yet")}saveDocs(t={}){return z(this,t)}};var Mt=(i,t=0)=>{if(t>i.length+4)return[-1];for(let n=t;n<i.length;n++){if(i[n]===125&&i[n+1]===44&&i[n+2]===13&&i[n+3]===10&&i[n+4]===123)return[n];if(i[n]===10&&i[n+1]===93&&i[n+2]===44)return[n,!0]}return[-1]},J=class extends TransformStream{constructor(t={}){t.numberOfChanges=0,t.lastSeq=null,super({start(){},transform(n,a){let c=new Uint8Array(this.data.length+n.length);c.set(this.data,0),c.set(n,this.data.length),this.data=c,this.startParsed||(this.data=this.data.slice(13),this.startParsed=!0);let f;do{f=null;let[l,d]=Mt(this.data);if(l!==-1){if(l>0){let p=this.decoder.decode(this.data.slice(0,l+1));f=JSON.parse(p),delete f.seq,t.numberOfChanges++,a.enqueue(f)}if(d){let p=this.decoder.decode(this.data.slice(l+4)),{last_seq:g}=JSON.parse(`{${p}`);t.lastSeq=g;return}this.data=this.data.slice(l+4)}}while(f)},flush(){},decoder:new TextDecoder,data:new Uint8Array(0),startParsed:!1})}};async function H(i,t,{limit:n}={},a={}){let c=new URL(`${i.root}/_changes`,i.url);c.searchParams.set("feed","normal"),c.searchParams.set("style","all_docs"),t&&c.searchParams.set("since",t),n&&(c.searchParams.set("limit",n),c.searchParams.set("seq_interval",n));let f=await fetch(c,{headers:i.headers});if(f.status!==200)throw new Error("Could not get changes");let l=new J(a),d=f.body.getReader();return new ReadableStream({async start(g){for(;;){let{done:v,value:m}=await d.read();if(v)break;g.enqueue(m)}g.close(),d.releaseLock()}}).pipeThrough(l)}function E(i,t,n=0){if(n>i.length+t.length+2)return-1;for(let a=n;a<i.length;a++)if(i[a]===45&&i[a+1]===45){let c,f;for(f=0;f<t.length;f++)if(c=!0,i[f+a+2]!==t[f]){c=!1;break}if(c)return a}return-1}function K(i,t=0){if(t>i.length+4)return-1;for(let n=t;n<i.length;n++)if(i[n]===13&&i[n+1]===10&&i[n+2]===13&&i[n+3]===10)return n;return-1}function Z(i,t,n=0){if(n>i.length+t.length+4||i[n]!==45||i[n+1]!==45||i[n+t.length+2]!==45||i[n+t.length+3]!==45)return!1;for(let a=0;a<t.length;a++)if(i[a+n+2]!==t[a])return!1;return!0}var P=class{constructor(t){this.encoder=new TextEncoder,this.decoder=new TextDecoder;let n=this.parseContentType(t);this.id=n.id,this.boundaries=[n]}parseContentType(t){let[n,a,c]=t.match(/^([^;]+);\s*boundary="?([^="]+)"?/)||[];if(a!=="multipart/related")return;let f=this.encoder.encode(c);return{id:c,boundary:f}}parsePart(t){if(this.boundaries.length===0)return null;let{id:n,boundary:a}=this.boundaries[this.boundaries.length-1],c=E(t,a);if(c===-1)return null;let f=K(t,c);if(f===-1)return null;let l=t.slice(a.length+4,f),p=this.decoder.decode(l).split(`\r
`).reduce((h,u)=>{let[r,e]=u.split(/:\s*/);return h[r]=r==="Content-Length"?parseInt(e,10):e,h},{}),{"Content-Type":g}=p;if(!g)return null;let{"Content-Length":v}=p,m=v?E(t,a,v+f+6):E(t,a,f+4);if(m===-1||t.length<m)return null;let b=this.parseContentType(g);if(b)return this.boundaries.push(b),this.parsePart(t.slice(f+4));let w=Z(t,a,m),R=w?m+a.length+6:m;w&&this.boundaries.pop();let _=t.slice(f+4,m-2),y=t.slice(R);return{boundary:this.id===n?null:n,headers:p,data:_,rest:y}}};var U=class{constructor(t){this.parser=new P(t),this.data=new Uint8Array(0)}read(t){if(t){let c=new Uint8Array(this.data.length+t.length);c.set(this.data,0),c.set(t,this.data.length),this.data=c}let n=[],a;do if(a=this.parser.parsePart(this.data),a){let{boundary:c,headers:f,data:l,rest:d}=a;this.data=d,n.push({boundary:c,headers:f,data:l})}while(a);return n}};var Ot=i=>{let t=new CompressionStream("gzip"),n=i.stream().pipeThrough(t);return new Response(n).blob()},$t=(i,t)=>{let n=new DecompressionStream("gzip"),a=i.stream().pipeThrough(n),c={headers:{"Content-Type":t}};return new Response(a,c).blob()},F=async(i,{decoder:t})=>{if(i.length===0)return;let{headers:n,data:a}=i.shift(),c=t.decode(a),f=JSON.parse(c);for(let{headers:l,data:d}of i){let p=l["Content-Disposition"];if(!p){console.warn("skipping attachment with missing Content-Disposition header",l,f,i);continue}let[g,v]=p.match(/filename="([^"]+)"/);if(!v){console.warn('missing filename in Content-Disposition header "%s"',p,l,f,i);continue}if(!(v in f._attachments)){console.warn('skipping attachment due to missing filename "%s" in docs attachments stub',v,l,f,i);continue}let m=l["Content-Type"];if(!m){console.warn("skipping attachment due to missing Content-Type header",l,f,i);continue}let b=new Blob([d],{type:m}),w=l["Content-Encoding"];if(w==="gzip")f._attachments[v].data=await $t(b,m),delete f._attachments[v].follows,delete f._attachments[v].encoding,delete f._attachments[v].encoded_length;else if(w){console.warn("skipping attachment with unsupported Content-Encoding header %s",w,l,f,i);continue}else f._attachments[v].data=b,delete f._attachments[v].follows}return f},G=class extends TransformStream{constructor(t,n){n.docsRead=0;let a=new TextDecoder;super({start(){},async transform(c,f){let l=new URL(`${t.root}/_bulk_get`,t.url);l.searchParams.set("revs","true"),l.searchParams.set("attachments","true");let d={docs:c},p=new Blob([JSON.stringify(d)],{type:"application/json"}),g=await Ot(p),v=await fetch(l,{headers:{...t.headers,"Content-Type":"application/json",Accept:"multipart/related","Content-Encoding":"gzip"},method:"post",body:g});if(v.status!==200)throw new Error("Could not get docs multipart");let m=v.headers.get("Content-Type"),b=new U(m),w=v.body.getReader(),R=!1,_=[],y=null,h;do{let{done:u,value:r}=await w.read(),e=b.read(r);for(let o of e)o.boundary?y&&y!==o.boundary?(h=await F(_,{decoder:a}),h&&(f.enqueue(h),n.docsRead++),_=[o],y=null):(_.push(o),y=o.boundary):(h=await F(_,{decoder:a}),h&&(f.enqueue(h),n.docsRead++),_=[],y=null,h=await F([o],{decoder:a}),h&&(f.enqueue(h),n.docsRead++));R=u}while(!R);h=await F(_,{decoder:a}),h&&(f.enqueue(h),n.docsRead++)},flush(){}})}};function Q(i,t={}){return new G(i,t)}var B=class{constructor({url:t,headers:n}){this.url=t,this.root=t.pathname,this.headers=n,this.changesParser=null}async getUuid(){let t=new URL(this.url);t.pathname="/";let n=await fetch(t,{headers:this.headers});if(n.status!==200)throw new Error("Remote server not reachable");let{uuid:a}=await n.json();return a}async getUpdateSeq(){let t=new URL(this.url),n=await fetch(t,{headers:this.headers});if(n.status!==200)throw new Error("Remote database not reachable");let{update_seq:a}=await n.json();return a}async getReplicationLog(t){let n=`_local/${t}`,a=new URL(`${this.root}/${n}`,this.url),c=await fetch(a,{headers:this.headers});return c.status===200?c.json():{_id:n}}async saveReplicationLog(t){let n=new URL(`${this.root}/${t._id}`,this.url),a=await fetch(n,{headers:{...this.headers,"Content-Type":"application/json"},method:"put",body:JSON.stringify(t)});if(a.status!==201)throw new Error("Could not save replication log");return a.json()}getChanges(t,{limit:n}={},a={}){return H(this,t,{limit:n},a)}getDiff(){throw new Error("Not supported for Remote yet")}getDocs(t={}){return Q(this,t)}saveDocs(t={}){throw new Error("Not supported for Remote yet")}};var gt=O(I(),1);var jt=async(i,t)=>gt.default.hash(`${i}${t}`),Wt=(i,t)=>i.session_id&&i.session_id===t.session_id&&i.source_last_seq&&i.source_last_seq===t.source_last_seq?i.source_last_seq:null,pt=(i,t)=>{if(!i)return-1;if(!t)return 1;if(i===t)return 0;let n=parseInt(i,10),a=parseInt(t,10);return n-a};async function M(i,t,{batchSize:n={getChanges:1024,getDiff:128,getDocs:512,saveDocs:512}}={}){let a=L(),c={docsRead:0,docsWritten:0},[f,l,d]=await Promise.all([t.getUuid(),i.getUuid(),i.getUpdateSeq()]),p=await jt(f,l),[g,v]=await Promise.all([t.getReplicationLog(p),i.getReplicationLog(p)]),m=Wt(g,v);if(pt(m,d)===0)return c;let b=!1;for(;!b;){let w={},R=await i.getChanges(m,{limit:n.getChanges},w),_=t.getDiff(),y=i.getDocs(w),h=t.saveDocs(w);if(await R.pipeThrough(new A({batchSize:n.getDiff})).pipeThrough(_).pipeThrough(new A({batchSize:n.getDocs})).pipeThrough(y).pipeThrough(new A({batchSize:n.saveDocs})).pipeTo(h),c.lastSeq=w.lastSeq,c.docsRead+=w.docsRead,c.docsWritten+=w.docsWritten,w.lastSeq!==m){v.session_id=a,v.source_last_seq=w.lastSeq,g.session_id=a,g.source_last_seq=w.lastSeq;let[{rev:u},{rev:r}]=await Promise.all([t.saveReplicationLog(g),i.saveReplicationLog(v)]);g._rev=u,v._rev=r}m=w.lastSeq,b=w.numberOfChanges<n.getChanges||pt(w.lastSeq,d)>=0}return c}var Nt=new Event("change"),X=class extends EventTarget{constructor({name:t,url:n,headers:a}){super(),this.local=new x({name:t}),this.remote=new B({url:n,headers:a})}init(){return this.local.init()}async pull(){console.time("pull");let t=await M(this.remote,this.local);return console.timeEnd("pull"),t.docsWritten>0&&this.dispatchEvent(Nt),t}push(){return M(this.local,this.remote)}sync(){return Promise.all([this.pull(),this.push()])}};export{X as default};
