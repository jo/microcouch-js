var mt=Object.create;var Y=Object.defineProperty;var wt=Object.getOwnPropertyDescriptor;var yt=Object.getOwnPropertyNames;var bt=Object.getPrototypeOf,_t=Object.prototype.hasOwnProperty;var St=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var Rt=(a,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let c of yt(t))!_t.call(a,c)&&c!==s&&Y(a,c,{get:()=>t[c],enumerable:!(i=wt(t,c))||i.enumerable});return a};var W=(a,t,s)=>(s=a!=null?mt(bt(a)):{},Rt(t||!a||!a.__esModule?Y(s,"default",{value:a,enumerable:!0}):s,a));var j=St((k,tt)=>{(function(a){if(typeof k=="object")tt.exports=a();else if(typeof define=="function"&&define.amd)define(a);else{var t;try{t=window}catch{t=self}t.SparkMD5=a()}})(function(a){"use strict";var t=function(l,u){return l+u&4294967295},s=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function i(l,u,e,r,o,n){return u=t(t(u,l),t(r,n)),t(u<<o|u>>>32-o,e)}function c(l,u){var e=l[0],r=l[1],o=l[2],n=l[3];e+=(r&o|~r&n)+u[0]-680876936|0,e=(e<<7|e>>>25)+r|0,n+=(e&r|~e&o)+u[1]-389564586|0,n=(n<<12|n>>>20)+e|0,o+=(n&e|~n&r)+u[2]+606105819|0,o=(o<<17|o>>>15)+n|0,r+=(o&n|~o&e)+u[3]-1044525330|0,r=(r<<22|r>>>10)+o|0,e+=(r&o|~r&n)+u[4]-176418897|0,e=(e<<7|e>>>25)+r|0,n+=(e&r|~e&o)+u[5]+1200080426|0,n=(n<<12|n>>>20)+e|0,o+=(n&e|~n&r)+u[6]-1473231341|0,o=(o<<17|o>>>15)+n|0,r+=(o&n|~o&e)+u[7]-45705983|0,r=(r<<22|r>>>10)+o|0,e+=(r&o|~r&n)+u[8]+1770035416|0,e=(e<<7|e>>>25)+r|0,n+=(e&r|~e&o)+u[9]-1958414417|0,n=(n<<12|n>>>20)+e|0,o+=(n&e|~n&r)+u[10]-42063|0,o=(o<<17|o>>>15)+n|0,r+=(o&n|~o&e)+u[11]-1990404162|0,r=(r<<22|r>>>10)+o|0,e+=(r&o|~r&n)+u[12]+1804603682|0,e=(e<<7|e>>>25)+r|0,n+=(e&r|~e&o)+u[13]-40341101|0,n=(n<<12|n>>>20)+e|0,o+=(n&e|~n&r)+u[14]-1502002290|0,o=(o<<17|o>>>15)+n|0,r+=(o&n|~o&e)+u[15]+1236535329|0,r=(r<<22|r>>>10)+o|0,e+=(r&n|o&~n)+u[1]-165796510|0,e=(e<<5|e>>>27)+r|0,n+=(e&o|r&~o)+u[6]-1069501632|0,n=(n<<9|n>>>23)+e|0,o+=(n&r|e&~r)+u[11]+643717713|0,o=(o<<14|o>>>18)+n|0,r+=(o&e|n&~e)+u[0]-373897302|0,r=(r<<20|r>>>12)+o|0,e+=(r&n|o&~n)+u[5]-701558691|0,e=(e<<5|e>>>27)+r|0,n+=(e&o|r&~o)+u[10]+38016083|0,n=(n<<9|n>>>23)+e|0,o+=(n&r|e&~r)+u[15]-660478335|0,o=(o<<14|o>>>18)+n|0,r+=(o&e|n&~e)+u[4]-405537848|0,r=(r<<20|r>>>12)+o|0,e+=(r&n|o&~n)+u[9]+568446438|0,e=(e<<5|e>>>27)+r|0,n+=(e&o|r&~o)+u[14]-1019803690|0,n=(n<<9|n>>>23)+e|0,o+=(n&r|e&~r)+u[3]-187363961|0,o=(o<<14|o>>>18)+n|0,r+=(o&e|n&~e)+u[8]+1163531501|0,r=(r<<20|r>>>12)+o|0,e+=(r&n|o&~n)+u[13]-1444681467|0,e=(e<<5|e>>>27)+r|0,n+=(e&o|r&~o)+u[2]-51403784|0,n=(n<<9|n>>>23)+e|0,o+=(n&r|e&~r)+u[7]+1735328473|0,o=(o<<14|o>>>18)+n|0,r+=(o&e|n&~e)+u[12]-1926607734|0,r=(r<<20|r>>>12)+o|0,e+=(r^o^n)+u[5]-378558|0,e=(e<<4|e>>>28)+r|0,n+=(e^r^o)+u[8]-2022574463|0,n=(n<<11|n>>>21)+e|0,o+=(n^e^r)+u[11]+1839030562|0,o=(o<<16|o>>>16)+n|0,r+=(o^n^e)+u[14]-35309556|0,r=(r<<23|r>>>9)+o|0,e+=(r^o^n)+u[1]-1530992060|0,e=(e<<4|e>>>28)+r|0,n+=(e^r^o)+u[4]+1272893353|0,n=(n<<11|n>>>21)+e|0,o+=(n^e^r)+u[7]-155497632|0,o=(o<<16|o>>>16)+n|0,r+=(o^n^e)+u[10]-1094730640|0,r=(r<<23|r>>>9)+o|0,e+=(r^o^n)+u[13]+681279174|0,e=(e<<4|e>>>28)+r|0,n+=(e^r^o)+u[0]-358537222|0,n=(n<<11|n>>>21)+e|0,o+=(n^e^r)+u[3]-722521979|0,o=(o<<16|o>>>16)+n|0,r+=(o^n^e)+u[6]+76029189|0,r=(r<<23|r>>>9)+o|0,e+=(r^o^n)+u[9]-640364487|0,e=(e<<4|e>>>28)+r|0,n+=(e^r^o)+u[12]-421815835|0,n=(n<<11|n>>>21)+e|0,o+=(n^e^r)+u[15]+530742520|0,o=(o<<16|o>>>16)+n|0,r+=(o^n^e)+u[2]-995338651|0,r=(r<<23|r>>>9)+o|0,e+=(o^(r|~n))+u[0]-198630844|0,e=(e<<6|e>>>26)+r|0,n+=(r^(e|~o))+u[7]+1126891415|0,n=(n<<10|n>>>22)+e|0,o+=(e^(n|~r))+u[14]-1416354905|0,o=(o<<15|o>>>17)+n|0,r+=(n^(o|~e))+u[5]-57434055|0,r=(r<<21|r>>>11)+o|0,e+=(o^(r|~n))+u[12]+1700485571|0,e=(e<<6|e>>>26)+r|0,n+=(r^(e|~o))+u[3]-1894986606|0,n=(n<<10|n>>>22)+e|0,o+=(e^(n|~r))+u[10]-1051523|0,o=(o<<15|o>>>17)+n|0,r+=(n^(o|~e))+u[1]-2054922799|0,r=(r<<21|r>>>11)+o|0,e+=(o^(r|~n))+u[8]+1873313359|0,e=(e<<6|e>>>26)+r|0,n+=(r^(e|~o))+u[15]-30611744|0,n=(n<<10|n>>>22)+e|0,o+=(e^(n|~r))+u[6]-1560198380|0,o=(o<<15|o>>>17)+n|0,r+=(n^(o|~e))+u[13]+1309151649|0,r=(r<<21|r>>>11)+o|0,e+=(o^(r|~n))+u[4]-145523070|0,e=(e<<6|e>>>26)+r|0,n+=(r^(e|~o))+u[11]-1120210379|0,n=(n<<10|n>>>22)+e|0,o+=(e^(n|~r))+u[2]+718787259|0,o=(o<<15|o>>>17)+n|0,r+=(n^(o|~e))+u[9]-343485551|0,r=(r<<21|r>>>11)+o|0,l[0]=e+l[0]|0,l[1]=r+l[1]|0,l[2]=o+l[2]|0,l[3]=n+l[3]|0}function h(l){var u=[],e;for(e=0;e<64;e+=4)u[e>>2]=l.charCodeAt(e)+(l.charCodeAt(e+1)<<8)+(l.charCodeAt(e+2)<<16)+(l.charCodeAt(e+3)<<24);return u}function f(l){var u=[],e;for(e=0;e<64;e+=4)u[e>>2]=l[e]+(l[e+1]<<8)+(l[e+2]<<16)+(l[e+3]<<24);return u}function d(l){var u=l.length,e=[1732584193,-271733879,-1732584194,271733878],r,o,n,R,T,D;for(r=64;r<=u;r+=64)c(e,h(l.substring(r-64,r)));for(l=l.substring(r-64),o=l.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r=0;r<o;r+=1)n[r>>2]|=l.charCodeAt(r)<<(r%4<<3);if(n[r>>2]|=128<<(r%4<<3),r>55)for(c(e,n),r=0;r<16;r+=1)n[r]=0;return R=u*8,R=R.toString(16).match(/(.*?)(.{0,8})$/),T=parseInt(R[2],16),D=parseInt(R[1],16)||0,n[14]=T,n[15]=D,c(e,n),e}function p(l){var u=l.length,e=[1732584193,-271733879,-1732584194,271733878],r,o,n,R,T,D;for(r=64;r<=u;r+=64)c(e,f(l.subarray(r-64,r)));for(l=r-64<u?l.subarray(r-64):new Uint8Array(0),o=l.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r=0;r<o;r+=1)n[r>>2]|=l[r]<<(r%4<<3);if(n[r>>2]|=128<<(r%4<<3),r>55)for(c(e,n),r=0;r<16;r+=1)n[r]=0;return R=u*8,R=R.toString(16).match(/(.*?)(.{0,8})$/),T=parseInt(R[2],16),D=parseInt(R[1],16)||0,n[14]=T,n[15]=D,c(e,n),e}function g(l){var u="",e;for(e=0;e<4;e+=1)u+=s[l>>e*8+4&15]+s[l>>e*8&15];return u}function v(l){var u;for(u=0;u<l.length;u+=1)l[u]=g(l[u]);return l.join("")}v(d("hello"))!=="5d41402abc4b2a76b9719d911017c592"&&(t=function(l,u){var e=(l&65535)+(u&65535),r=(l>>16)+(u>>16)+(e>>16);return r<<16|e&65535}),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function l(u,e){return u=u|0||0,u<0?Math.max(u+e,0):Math.min(u,e)}ArrayBuffer.prototype.slice=function(u,e){var r=this.byteLength,o=l(u,r),n=r,R,T,D,X;return e!==a&&(n=l(e,r)),o>n?new ArrayBuffer(0):(R=n-o,T=new ArrayBuffer(R),D=new Uint8Array(T),X=new Uint8Array(this,o,R),D.set(X),T)}}();function m(l){return/[\u0080-\uFFFF]/.test(l)&&(l=unescape(encodeURIComponent(l))),l}function b(l,u){var e=l.length,r=new ArrayBuffer(e),o=new Uint8Array(r),n;for(n=0;n<e;n+=1)o[n]=l.charCodeAt(n);return u?o:r}function y(l){return String.fromCharCode.apply(null,new Uint8Array(l))}function S(l,u,e){var r=new Uint8Array(l.byteLength+u.byteLength);return r.set(new Uint8Array(l)),r.set(new Uint8Array(u),l.byteLength),e?r:r.buffer}function _(l){var u=[],e=l.length,r;for(r=0;r<e-1;r+=2)u.push(parseInt(l.substr(r,2),16));return String.fromCharCode.apply(String,u)}function w(){this.reset()}return w.prototype.append=function(l){return this.appendBinary(m(l)),this},w.prototype.appendBinary=function(l){this._buff+=l,this._length+=l.length;var u=this._buff.length,e;for(e=64;e<=u;e+=64)c(this._hash,h(this._buff.substring(e-64,e)));return this._buff=this._buff.substring(e-64),this},w.prototype.end=function(l){var u=this._buff,e=u.length,r,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n;for(r=0;r<e;r+=1)o[r>>2]|=u.charCodeAt(r)<<(r%4<<3);return this._finish(o,e),n=v(this._hash),l&&(n=_(n)),this.reset(),n},w.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},w.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},w.prototype.setState=function(l){return this._buff=l.buff,this._length=l.length,this._hash=l.hash,this},w.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},w.prototype._finish=function(l,u){var e=u,r,o,n;if(l[e>>2]|=128<<(e%4<<3),e>55)for(c(this._hash,l),e=0;e<16;e+=1)l[e]=0;r=this._length*8,r=r.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(r[2],16),n=parseInt(r[1],16)||0,l[14]=o,l[15]=n,c(this._hash,l)},w.hash=function(l,u){return w.hashBinary(m(l),u)},w.hashBinary=function(l,u){var e=d(l),r=v(e);return u?_(r):r},w.ArrayBuffer=function(){this.reset()},w.ArrayBuffer.prototype.append=function(l){var u=S(this._buff.buffer,l,!0),e=u.length,r;for(this._length+=l.byteLength,r=64;r<=e;r+=64)c(this._hash,f(u.subarray(r-64,r)));return this._buff=r-64<e?new Uint8Array(u.buffer.slice(r-64)):new Uint8Array(0),this},w.ArrayBuffer.prototype.end=function(l){var u=this._buff,e=u.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o,n;for(o=0;o<e;o+=1)r[o>>2]|=u[o]<<(o%4<<3);return this._finish(r,e),n=v(this._hash),l&&(n=_(n)),this.reset(),n},w.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},w.ArrayBuffer.prototype.getState=function(){var l=w.prototype.getState.call(this);return l.buff=y(l.buff),l},w.ArrayBuffer.prototype.setState=function(l){return l.buff=b(l.buff,!0),w.prototype.setState.call(this,l)},w.ArrayBuffer.prototype.destroy=w.prototype.destroy,w.ArrayBuffer.prototype._finish=w.prototype._finish,w.ArrayBuffer.hash=function(l,u){var e=p(new Uint8Array(l)),r=v(e);return u?_(r):r},w})});var ft=W(j(),1);function st(a){for(var t,s,i,c=a.rev_tree.slice(),h;h=c.pop();){var f=h.ids,d=f[2],p=h.pos;if(d.length){for(var g=0,v=d.length;g<v;g++)c.push({pos:p+1,ids:d[g]});continue}var m=!!f[1].deleted,b=f[0];(!t||(i!==m?i:s!==p?s<p:t<b))&&(t=b,s=p,i=m)}return s+"-"+t}function nt(a,t){for(var s=a.slice(),i;i=s.pop();)for(var c=i.pos,h=i.ids,f=h[2],d=t(f.length===0,c,h[0],i.ctx,h[1]),p=0,g=f.length;p<g;p++)s.push({pos:c+1,ids:f[p],ctx:d})}function ot(a){var t=[];return nt(a.rev_tree,function(s,i,c,h,f){f.status==="available"&&!s&&(t.push(i+"-"+c),f.status="missing")}),t}function Tt(a){for(var t=[],s=a.slice(),i;i=s.pop();){var c=i.pos,h=i.ids,f=h[0],d=h[1],p=h[2],g=p.length===0,v=i.history?i.history.slice():[];v.push({id:f,opts:d}),g&&t.push({pos:c+1-v.length,ids:v});for(var m=0,b=p.length;m<b;m++)s.push({pos:c+1,ids:p[m],history:v})}return t.reverse()}function Ct(a,t){return a.pos-t.pos}function Dt(a,t,s){for(var i=0,c=a.length,h;i<c;)h=i+c>>>1,s(a[h],t)<0?i=h+1:c=h;return i}function At(a,t,s){var i=Dt(a,t,s);a.splice(i,0,t)}function et(a,t){for(var s,i,c=t,h=a.length;c<h;c++){var f=a[c],d=[f.id,f.opts,[]];i?(i[2].push(d),i=d):s=i=d}return s}function xt(a,t){return a[0]<t[0]?-1:1}function rt(a,t){for(var s=[{tree1:a,tree2:t}],i=!1;s.length>0;){var c=s.pop(),h=c.tree1,f=c.tree2;(h[1].status||f[1].status)&&(h[1].status=h[1].status==="available"||f[1].status==="available"?"available":"missing");for(var d=0;d<f[2].length;d++){if(!h[2][0]){i="new_leaf",h[2][0]=f[2][d];continue}for(var p=!1,g=0;g<h[2].length;g++)h[2][g][0]===f[2][d][0]&&(s.push({tree1:h[2][g],tree2:f[2][d]}),p=!0);p||(i="new_branch",At(h[2],f[2][d],xt))}}return{conflicts:i,tree:a}}function at(a,t,s){var i=[],c=!1,h=!1,f;if(!a.length)return{tree:[t],conflicts:"new_leaf"};for(var d=0,p=a.length;d<p;d++){var g=a[d];if(g.pos===t.pos&&g.ids[0]===t.ids[0])f=rt(g.ids,t.ids),i.push({pos:g.pos,ids:f.tree}),c=c||f.conflicts,h=!0;else if(s!==!0){var v=g.pos<t.pos?g:t,m=g.pos<t.pos?t:g,b=m.pos-v.pos,y=[],S=[];for(S.push({ids:v.ids,diff:b,parent:null,parentIdx:null});S.length>0;){var _=S.pop();if(_.diff===0){_.ids[0]===m.ids[0]&&y.push(_);continue}for(var w=_.ids[2],l=0,u=w.length;l<u;l++)S.push({ids:w[l],diff:_.diff-1,parent:_.ids,parentIdx:l})}var e=y[0];e?(f=rt(e.ids,m.ids),e.parent[2][e.parentIdx]=f.tree,i.push({pos:v.pos,ids:v.ids}),c=c||f.conflicts,h=!0):i.push(g)}else i.push(g)}return h||i.push(t),i.sort(Ct),{tree:i,conflicts:c||"internal_node"}}function qt(a,t){for(var s=Tt(a),i,c,h=0,f=s.length;h<f;h++){var d=s[h],p=d.ids,g;if(p.length>t){i||(i={});var v=p.length-t;g={pos:d.pos+v,ids:et(p,v)};for(var m=0;m<v;m++){var b=d.pos+m+"-"+p[m].id;i[b]=!0}}else g={pos:d.pos,ids:et(p,0)};c?c=at(c,g,!0).tree:c=[g]}return i&&nt(c,function(y,S,_){delete i[S+"-"+_]}),{tree:c,revs:i?Object.keys(i):[]}}function it(a,t,s){var i=at(a,t),c=qt(i.tree,s);return{tree:c.tree,stemmedRevs:c.revs,conflicts:i.conflicts}}var ct=W(j(),1),Bt=32768,ut=async a=>{let t=Math.min(Bt,a.size),s=Math.ceil(a.size/t),i=new ct.default.ArrayBuffer;for(let c=0;c<s;c++){let f=await a.slice(c*t,(c+1)*t).arrayBuffer();i.append(f)}return i.end(!0)},O=()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,a=>(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)),x=class extends TransformStream{constructor({batchSize:t}){super({start(){},transform(s,i){if(this.entries.push(s),this.entries.length>=t){let c=this.entries.splice(0,t);i.enqueue(c)}},flush(s){this.entries.length>0&&s.enqueue(this.entries)},entries:[]})}},q=class extends ReadableStream{constructor(t){super({async start(s){for(;;){let{done:i,value:c}=await t.read();if(i)break;s.enqueue(c)}s.close(),t.releaseLock()}})}},lt=a=>{let t=new CompressionStream("gzip"),s=a.stream().getReader(),c=new q(s).pipeThrough(t);return new Response(c).blob()},ht=(a,t)=>{let s=new DecompressionStream("gzip"),i=a.stream().pipeThrough(s),c={headers:{"Content-Type":t}};return new Response(i,c).blob()};var C="docs",A="meta",Ut=1e3,z={status:"available"},dt={status:"missing"},Et=a=>{let[t,s]=a.split("-");return[parseInt(t,10),s]},It=a=>{let t=a.start-a.ids.length+1,s=a.ids,i=[s[0],z,[]];for(let c=1,h=s.length;c<h;c++)i=[s[c],dt,[i]];return[{pos:t,ids:i}]},Pt=async a=>{let t=await ut(a);return`md5-${btoa(t)}`},Lt=a=>{let t={};for(let i in a)i!=="_revisions"&&(t[i]=a[i]);let s=JSON.stringify(t);return ft.default.hash(s)},Ft=async(a,t,s)=>{if(!a)return t;for(let i in a){let c=a[i],{stub:h}=c;if(h){let{digest:f}=c;t[f].revs[s]=!0}else{let{content_type:f,data:d}=c;if(typeof d=="string")throw new Error("Base64 attachments are not supported");let p=c.digest||await Pt(d);c.digest=p,c.revpos=parseInt(s,10),t[p]={data:d,revs:{[s]:!0}}}}return t},Mt=a=>{let t={};for(let s in a)s.startsWith("_")||(t[s]=a[s]);if(a._attachments){t._attachments={};for(let s in a._attachments){let{digest:i,revpos:c}=a._attachments[s];t._attachments[s]={digest:i,revpos:c}}}return t},$t=async(a,t,s,{newEdits:i}={newEdits:!0})=>{let c;if(i){let o=await Lt(t),n;if(t._rev){let[R,T]=Et(t._rev);n=R+1,c=[{pos:R,ids:[T,dt,[[o,z,[]]]]}]}else n=1,c=[{pos:1,ids:[o,z,[]]}];t._rev=`${n}-${o}`}else c=It(t._revisions);let{_id:h,_rev:f,_deleted:d,_attachments:p}=t,g=s?s.attachments:{},v=await Ft(p,g,f),m=Mt(t),b=s?s.rev_tree:[],{tree:y,stemmedRevs:S}=it(b,c[0],Ut),_=st({rev_tree:y}),l={...s?s.revs:null,[f]:{data:m,deleted:!!d}},u=l[_].deleted,r=ot({rev_tree:y}).concat(S);for(let o of r)delete l[o];return{attachments:v,deleted:u,id:h,rev:_,rev_tree:y,revs:l,seq:a}},B=class{constructor({name:t}){this.name=t,this.db=null,this.metadata=null}async init(){if(!this.db)return new Promise((t,s)=>{let i=indexedDB.open(this.name);i.onupgradeneeded=c=>{let h=c.target.result,f="id";h.createObjectStore(C,{keyPath:f}).createIndex("seq","seq",{unique:!0}),h.createObjectStore(A,{keyPath:f})},i.onsuccess=c=>{this.db=c.target.result,this.db.onabort=()=>this.db.close(),this.db.onversionchange=()=>this.db.close();let h=this.db.transaction(A,"readwrite");h.oncomplete=()=>t();let f=h.objectStore(A);f.get(A).onsuccess=d=>{this.metadata=d.target.result||{id:A};let p=!1;"doc_count"in this.metadata||(p=!0,this.metadata.doc_count=0),"seq"in this.metadata||(p=!0,this.metadata.seq=0),"db_uuid"in this.metadata||(p=!0,this.metadata.db_uuid=O()),p&&f.put(this.metadata)}},i.onerror=c=>s(c.target.error),i.onblocked=c=>s(c)})}destroy(){return new Promise((t,s)=>{this.db.close();let i=indexedDB.deleteDatabase(this.name);i.onsuccess=()=>{this.db=null,this.metadata=null,t()}})}getLocalDoc(t){let s=`_local/${t}`;return new Promise((i,c)=>{this.db.transaction(C,"readonly").objectStore(C).get(s).onsuccess=h=>{let f=h.target.result,d=f?f.data:{_id:s};i(d)}})}saveLocalDoc(t){return t._rev=t._rev?t._rev+1:1,new Promise((s,i)=>{let c={id:t._id,data:t};this.db.transaction(C,"readwrite").objectStore(C).put(c).onsuccess=()=>s({rev:t._rev})})}getDocStore(t){return this.db.transaction(C,t).objectStore(C)}async buildEntries(t){let s=[];for(let{doc:i,existingEntry:c}of t){let h=++this.metadata.seq,f=await $t(h,i,c,{newEdits:!1}),d,{deleted:p}=f;c?c.deleted?d=p?0:1:d=p?-1:0:d=p?0:1,this.metadata.doc_count+=d,s.push(f)}return s}async saveEntries(t){return new Promise((s,i)=>{let c=this.db.transaction([C,A],"readwrite"),h=c.objectStore(C),f=c.objectStore(A),d=0,p=t.length;for(let g of t)h.put(g).onsuccess=()=>{d++,p--,p===0&&(f.put(this.metadata).onsuccess=()=>s(d))}})}async saveDocs(t){let s=await this.buildEntries(t);return this.saveEntries(s)}};var V=class extends TransformStream{constructor(t){super({start(){},async transform(s,i){return new Promise((c,h)=>{let f=t.getDocStore("readonly"),d=s.length;for(let p of s){let{id:g,revs:v}=p;f.get(g).onsuccess=m=>{d--;let b=m.target.result;b?i.enqueue({id:g,revs:v.filter(y=>y in b.revs),entry:b}):i.enqueue({id:g,revs:v}),d===0&&c()}}})},flush(){}})}},J=class extends WritableStream{constructor(t,s={}){s.docsWritten=0,super({async write(i){s.docsWritten+=await t.saveDocs(i)},close(){}})}},U=class{constructor(t){this.database=t}getUuid(){let{db_uuid:t}=this.database.metadata;return t}getUpdateSeq(){let{seq:t}=this.database.metadata;return t}getReplicationLog(t){return this.database.getLocalDoc(t)}saveReplicationLog(t){return this.database.saveLocalDoc(t)}getChanges(t,{limit:s}={},i={}){throw new Error("Not supported for Local yet")}filterMissingRevs(){return new V(this.database)}getDocs(t={}){throw new Error("Not supported for Local yet")}saveDocs(t={}){return new J(this.database,t)}};var E=class{constructor({name:t}){this.name=t,this.database=new B({name:t}),this.replicator=new U(this.database)}init(){return this.database.init()}destroy(){return this.database.destroy()}};var pt=a=>{let t=new Blob([JSON.stringify(a)],{type:"application/json"});return lt(t)},I=class{constructor({url:t,headers:s}){this.url=t,this.root=t.pathname,this.headers=s}async getServerInfo(){let t=new URL(this.url);t.pathname="/";let s=await fetch(t,{headers:this.headers});if(s.status!==200)throw new Error("Remote server not reachable");return s}async getInfo(){let t=new URL(this.url),s=await fetch(t,{headers:this.headers});if(s.status!==200)throw new Error("Remote database not reachable");return s}async getDoc(t){let s=new URL(`${this.root}/${t}`,this.url),i=await fetch(s,{headers:this.headers});if(i.status!==200)throw new Error("Could not get doc");return i}async saveDoc(t){let s=new URL(`${this.root}/${t._id}`,this.url),i=await pt(t),c=await fetch(s,{headers:{...this.headers,"Content-Type":"application/json","Content-Encoding":"gzip"},method:"put",body:i});if(c.status!==201)throw new Error("Could not save doc");return c}async getChanges(t,{limit:s}={}){let i=new URL(`${this.root}/_changes`,this.url);i.searchParams.set("feed","normal"),i.searchParams.set("style","all_docs"),t&&i.searchParams.set("since",t),s&&(i.searchParams.set("limit",s),i.searchParams.set("seq_interval",s));let c=await fetch(i,{headers:this.headers});if(c.status!==200)throw new Error("Could not get changes");return c}async bulkGet(t){let s=new URL(`${this.root}/_bulk_get`,this.url);s.searchParams.set("revs","true"),s.searchParams.set("attachments","true");let i=await pt({docs:t}),c=await fetch(s,{headers:{...this.headers,"Content-Type":"application/json",Accept:"multipart/related","Content-Encoding":"gzip"},method:"post",body:i});if(c.status!==200)throw new Error("Could not get docs multipart");return c}};function P(a,t,s=0){if(s>a.length+t.length+2)return-1;for(let i=s;i<a.length;i++)if(a[i]===45&&a[i+1]===45){let c,h;for(h=0;h<t.length;h++)if(c=!0,a[h+i+2]!==t[h]){c=!1;break}if(c)return i}return-1}function H(a,t=0){if(t>a.length+4)return-1;for(let s=t;s<a.length;s++)if(a[s]===13&&a[s+1]===10&&a[s+2]===13&&a[s+3]===10)return s;return-1}function G(a,t,s=0){if(s>a.length+t.length+4||a[s]!==45||a[s+1]!==45||a[s+t.length+2]!==45||a[s+t.length+3]!==45)return!1;for(let i=0;i<t.length;i++)if(a[i+s+2]!==t[i])return!1;return!0}var L=class{constructor(t){this.encoder=new TextEncoder,this.decoder=new TextDecoder;let s=this.parseContentType(t);this.id=s.id,this.boundaries=[s]}parseContentType(t){let[s,i,c]=t.match(/^([^;]+);\s*boundary="?([^="]+)"?/)||[];if(i!=="multipart/related")return;let h=this.encoder.encode(c);return{id:c,boundary:h}}parsePart(t){if(this.boundaries.length===0)return null;let{id:s,boundary:i}=this.boundaries[this.boundaries.length-1],c=P(t,i);if(c===-1)return null;let h=H(t,c);if(h===-1)return null;let f=t.slice(i.length+4,h),p=this.decoder.decode(f).split(`\r
`).reduce((l,u)=>{let[e,r]=u.split(/:\s*/);return l[e]=e==="Content-Length"?parseInt(r,10):r,l},{}),{"Content-Type":g}=p;if(!g)return null;let{"Content-Length":v}=p,m=v?P(t,i,v+h+6):P(t,i,h+4);if(m===-1||t.length<m)return null;let b=this.parseContentType(g);if(b)return this.boundaries.push(b),this.parsePart(t.slice(h+4));let y=G(t,i,m),S=y?m+i.length+6:m;y&&this.boundaries.pop();let _=t.slice(h+4,m-2),w=t.slice(S);return{boundary:this.id===s?null:s,headers:p,data:_,rest:w}}};var F=class{constructor(t){this.parser=new L(t),this.data=new Uint8Array(0)}read(t){if(t){let c=new Uint8Array(this.data.length+t.length);c.set(this.data,0),c.set(t,this.data.length),this.data=c}let s=[],i;do if(i=this.parser.parsePart(this.data),i){let{boundary:c,headers:h,data:f,rest:d}=i;this.data=d,s.push({boundary:c,headers:h,data:f})}while(i);return s}};var jt=(a,t=0)=>{if(t>a.length+4)return[-1];for(let s=t;s<a.length;s++){if(a[s]===125&&a[s+1]===44&&a[s+2]===13&&a[s+3]===10&&a[s+4]===123)return[s];if(a[s]===10&&a[s+1]===93&&a[s+2]===44)return[s,!0]}return[-1]},K=class extends TransformStream{constructor(t={}){t.numberOfChanges=0,t.lastSeq=null,super({start(){},transform(s,i){let c=new Uint8Array(this.data.length+s.length);c.set(this.data,0),c.set(s,this.data.length),this.data=c,this.startParsed||(this.data=this.data.slice(13),this.startParsed=!0);let h;do{h=null;let[f,d]=jt(this.data);if(f!==-1){if(f>0){let p=this.decoder.decode(this.data.slice(0,f+1));h=JSON.parse(p);let{id:g,changes:v,deleted:m}=h,b=v.map(({rev:S})=>S),y={id:g,revs:b};m&&(y.deleted=!0),t.numberOfChanges++,i.enqueue(y)}if(d){let p=this.decoder.decode(this.data.slice(f+4)),{last_seq:g}=JSON.parse(`{${p}`);t.lastSeq=g;return}this.data=this.data.slice(f+4)}}while(h)},flush(){},decoder:new TextDecoder,data:new Uint8Array(0),startParsed:!1})}},Ot=async(a,{decoder:t})=>{if(a.length===0)return;let{headers:s,data:i}=a.shift(),c=t.decode(i),h=JSON.parse(c);for(let{headers:f,data:d}of a){let p=f["Content-Disposition"];if(!p){console.warn("skipping attachment with missing Content-Disposition header",f,h,a);continue}let[g,v]=p.match(/filename="([^"]+)"/);if(!v){console.warn('missing filename in Content-Disposition header "%s"',p,f,h,a);continue}if(!(v in h._attachments)){console.warn('skipping attachment due to missing filename "%s" in docs attachments stub',v,f,h,a);continue}let m=f["Content-Type"];if(!m){console.warn("skipping attachment due to missing Content-Type header",f,h,a);continue}let b=new Blob([d],{type:m}),y=f["Content-Encoding"];if(y==="gzip")h._attachments[v].data=await ht(b,m),delete h._attachments[v].follows,delete h._attachments[v].encoding,delete h._attachments[v].encoded_length;else if(y){console.warn("skipping attachment with unsupported Content-Encoding header %s",y,f,h,a);continue}else h._attachments[v].data=b,delete h._attachments[v].follows}return h},Z=class extends TransformStream{constructor(t,s){s.docsRead=0;let i=new TextDecoder;super({start(){},async transform(c,h){let f=[],d={};for(let{id:w,revs:l,entry:u}of c){d[w]=u;for(let e of l)f.push({id:w,rev:e})}let p=async w=>{let l=await Ot(w,{decoder:i});if(l){let u=d[l._id];h.enqueue({doc:l,entry:u}),s.docsRead++}},g=await t.bulkGet(f),v=g.headers.get("Content-Type"),m=new F(v),b=g.body.getReader(),y=!1,S=[],_=null;do{let{done:w,value:l}=await b.read(),u=m.read(l);for(let e of u)e.boundary?_&&_!==e.boundary?(p(S),S=[e],_=null):(S.push(e),_=e.boundary):(p(S),S=[],_=null,p([e]));y=w}while(!y);p(S)},flush(){}},{highWaterMark:8})}},M=class{constructor(t){this.database=t}async getUuid(){let t=await this.database.getServerInfo(),{uuid:s}=await t.json();return s}async getUpdateSeq(){let t=await this.database.getInfo(),{update_seq:s}=await t.json();return s}async getReplicationLog(t){let s=`_local/${t}`,i;try{i=await(await this.database.getDoc(s)).json()}catch{i={_id:s}}return i}async saveReplicationLog(t){return(await this.database.saveDoc(t)).json()}async getChanges(t,{limit:s}={},i={}){let c=await this.database.getChanges(t,{limit:s}),h=new K(i),f=c.body.getReader();return new q(f).pipeThrough(h)}filterMissingRevs(){throw new Error("Not supported for Remote yet")}getDocs(t={}){return new Z(this.database,t)}saveDocs(t={}){throw new Error("Not supported for Remote yet")}};var $=class{constructor({url:t,headers:s}){this.database=new I({url:t,headers:s}),this.replicator=new M(this.database)}};var vt=W(j(),1);var Nt=async(a,t)=>vt.default.hash(`${a}${t}`),Wt=(a,t)=>a.session_id&&a.session_id===t.session_id&&a.source_last_seq&&a.source_last_seq===t.source_last_seq?a.source_last_seq:null,gt=(a,t)=>{if(!a)return-1;if(!t)return 1;if(a===t)return 0;let s=parseInt(a,10),i=parseInt(t,10);return s-i};async function N(a,t,{batchSize:s={getChanges:512*8,getDiff:512,getDocs:1024,saveDocs:512}}={}){let i=O(),c={docsRead:0,docsWritten:0},[h,f,d]=await Promise.all([t.replicator.getUuid(),a.replicator.getUuid(),a.replicator.getUpdateSeq()]),p=await Nt(h,f),[g,v]=await Promise.all([t.replicator.getReplicationLog(p),a.replicator.getReplicationLog(p)]),m=Wt(g,v);if(gt(m,d)===0)return c;let b=!1;for(;!b;){let y={},S=await a.replicator.getChanges(m,{limit:s.getChanges},y),_=t.replicator.filterMissingRevs(),w=a.replicator.getDocs(y),l=t.replicator.saveDocs(y),u=new WritableStream({write(e){console.log(e)},close(){console.log("complete.")}});if(await S.pipeThrough(new x({batchSize:s.getDiff})).pipeThrough(_).pipeThrough(new x({batchSize:s.getDocs})).pipeThrough(w).pipeThrough(new x({batchSize:s.saveDocs})).pipeTo(l),c.lastSeq=y.lastSeq,c.docsRead+=y.docsRead,c.docsWritten+=y.docsWritten,y.lastSeq!==m){v.session_id=i,v.source_last_seq=y.lastSeq,g.session_id=i,g.source_last_seq=y.lastSeq;let[{rev:e},{rev:r}]=await Promise.all([t.replicator.saveReplicationLog(g),a.replicator.saveReplicationLog(v)]);g._rev=e,v._rev=r}m=y.lastSeq,b=y.numberOfChanges<s.getChanges||gt(y.lastSeq,d)>=0}return c}var zt=new Event("change"),Q=class extends EventTarget{constructor({name:t,url:s,headers:i}){super(),this.local=new E({name:t}),this.remote=new $({url:s,headers:i})}init(){return this.local.init()}async pull(){console.time("pull");let t=await N(this.remote,this.local);return console.timeEnd("pull"),t.docsWritten>0&&this.dispatchEvent(zt),t}push(){return N(this.local,this.remote)}sync(){return Promise.all([this.pull(),this.push()])}};export{Q as default};
