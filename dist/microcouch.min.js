var xt=Object.create;var ot=Object.defineProperty;var Et=Object.getOwnPropertyDescriptor;var Dt=Object.getOwnPropertyNames;var At=Object.getPrototypeOf,It=Object.prototype.hasOwnProperty;var qt=(c,t)=>()=>(t||c((t={exports:{}}).exports,t),t.exports);var Lt=(c,t,s,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Dt(t))!It.call(c,i)&&i!==s&&ot(c,i,{get:()=>t[i],enumerable:!(a=Et(t,i))||a.enumerable});return c};var Ct=(c,t,s)=>(s=c!=null?xt(At(c)):{},Lt(t||!c||!c.__esModule?ot(s,"default",{value:c,enumerable:!0}):s,c));var ct=qt((at,it)=>{(function(c){if(typeof at=="object")it.exports=c();else if(typeof define=="function"&&define.amd)define(c);else{var t;try{t=window}catch{t=self}t.SparkMD5=c()}})(function(c){"use strict";var t=function(f,h){return f+h&4294967295},s=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function a(f,h,r,e,o,n){return h=t(t(h,f),t(e,n)),t(h<<o|h>>>32-o,r)}function i(f,h){var r=f[0],e=f[1],o=f[2],n=f[3];r+=(e&o|~e&n)+h[0]-680876936|0,r=(r<<7|r>>>25)+e|0,n+=(r&e|~r&o)+h[1]-389564586|0,n=(n<<12|n>>>20)+r|0,o+=(n&r|~n&e)+h[2]+606105819|0,o=(o<<17|o>>>15)+n|0,e+=(o&n|~o&r)+h[3]-1044525330|0,e=(e<<22|e>>>10)+o|0,r+=(e&o|~e&n)+h[4]-176418897|0,r=(r<<7|r>>>25)+e|0,n+=(r&e|~r&o)+h[5]+1200080426|0,n=(n<<12|n>>>20)+r|0,o+=(n&r|~n&e)+h[6]-1473231341|0,o=(o<<17|o>>>15)+n|0,e+=(o&n|~o&r)+h[7]-45705983|0,e=(e<<22|e>>>10)+o|0,r+=(e&o|~e&n)+h[8]+1770035416|0,r=(r<<7|r>>>25)+e|0,n+=(r&e|~r&o)+h[9]-1958414417|0,n=(n<<12|n>>>20)+r|0,o+=(n&r|~n&e)+h[10]-42063|0,o=(o<<17|o>>>15)+n|0,e+=(o&n|~o&r)+h[11]-1990404162|0,e=(e<<22|e>>>10)+o|0,r+=(e&o|~e&n)+h[12]+1804603682|0,r=(r<<7|r>>>25)+e|0,n+=(r&e|~r&o)+h[13]-40341101|0,n=(n<<12|n>>>20)+r|0,o+=(n&r|~n&e)+h[14]-1502002290|0,o=(o<<17|o>>>15)+n|0,e+=(o&n|~o&r)+h[15]+1236535329|0,e=(e<<22|e>>>10)+o|0,r+=(e&n|o&~n)+h[1]-165796510|0,r=(r<<5|r>>>27)+e|0,n+=(r&o|e&~o)+h[6]-1069501632|0,n=(n<<9|n>>>23)+r|0,o+=(n&e|r&~e)+h[11]+643717713|0,o=(o<<14|o>>>18)+n|0,e+=(o&r|n&~r)+h[0]-373897302|0,e=(e<<20|e>>>12)+o|0,r+=(e&n|o&~n)+h[5]-701558691|0,r=(r<<5|r>>>27)+e|0,n+=(r&o|e&~o)+h[10]+38016083|0,n=(n<<9|n>>>23)+r|0,o+=(n&e|r&~e)+h[15]-660478335|0,o=(o<<14|o>>>18)+n|0,e+=(o&r|n&~r)+h[4]-405537848|0,e=(e<<20|e>>>12)+o|0,r+=(e&n|o&~n)+h[9]+568446438|0,r=(r<<5|r>>>27)+e|0,n+=(r&o|e&~o)+h[14]-1019803690|0,n=(n<<9|n>>>23)+r|0,o+=(n&e|r&~e)+h[3]-187363961|0,o=(o<<14|o>>>18)+n|0,e+=(o&r|n&~r)+h[8]+1163531501|0,e=(e<<20|e>>>12)+o|0,r+=(e&n|o&~n)+h[13]-1444681467|0,r=(r<<5|r>>>27)+e|0,n+=(r&o|e&~o)+h[2]-51403784|0,n=(n<<9|n>>>23)+r|0,o+=(n&e|r&~e)+h[7]+1735328473|0,o=(o<<14|o>>>18)+n|0,e+=(o&r|n&~r)+h[12]-1926607734|0,e=(e<<20|e>>>12)+o|0,r+=(e^o^n)+h[5]-378558|0,r=(r<<4|r>>>28)+e|0,n+=(r^e^o)+h[8]-2022574463|0,n=(n<<11|n>>>21)+r|0,o+=(n^r^e)+h[11]+1839030562|0,o=(o<<16|o>>>16)+n|0,e+=(o^n^r)+h[14]-35309556|0,e=(e<<23|e>>>9)+o|0,r+=(e^o^n)+h[1]-1530992060|0,r=(r<<4|r>>>28)+e|0,n+=(r^e^o)+h[4]+1272893353|0,n=(n<<11|n>>>21)+r|0,o+=(n^r^e)+h[7]-155497632|0,o=(o<<16|o>>>16)+n|0,e+=(o^n^r)+h[10]-1094730640|0,e=(e<<23|e>>>9)+o|0,r+=(e^o^n)+h[13]+681279174|0,r=(r<<4|r>>>28)+e|0,n+=(r^e^o)+h[0]-358537222|0,n=(n<<11|n>>>21)+r|0,o+=(n^r^e)+h[3]-722521979|0,o=(o<<16|o>>>16)+n|0,e+=(o^n^r)+h[6]+76029189|0,e=(e<<23|e>>>9)+o|0,r+=(e^o^n)+h[9]-640364487|0,r=(r<<4|r>>>28)+e|0,n+=(r^e^o)+h[12]-421815835|0,n=(n<<11|n>>>21)+r|0,o+=(n^r^e)+h[15]+530742520|0,o=(o<<16|o>>>16)+n|0,e+=(o^n^r)+h[2]-995338651|0,e=(e<<23|e>>>9)+o|0,r+=(o^(e|~n))+h[0]-198630844|0,r=(r<<6|r>>>26)+e|0,n+=(e^(r|~o))+h[7]+1126891415|0,n=(n<<10|n>>>22)+r|0,o+=(r^(n|~e))+h[14]-1416354905|0,o=(o<<15|o>>>17)+n|0,e+=(n^(o|~r))+h[5]-57434055|0,e=(e<<21|e>>>11)+o|0,r+=(o^(e|~n))+h[12]+1700485571|0,r=(r<<6|r>>>26)+e|0,n+=(e^(r|~o))+h[3]-1894986606|0,n=(n<<10|n>>>22)+r|0,o+=(r^(n|~e))+h[10]-1051523|0,o=(o<<15|o>>>17)+n|0,e+=(n^(o|~r))+h[1]-2054922799|0,e=(e<<21|e>>>11)+o|0,r+=(o^(e|~n))+h[8]+1873313359|0,r=(r<<6|r>>>26)+e|0,n+=(e^(r|~o))+h[15]-30611744|0,n=(n<<10|n>>>22)+r|0,o+=(r^(n|~e))+h[6]-1560198380|0,o=(o<<15|o>>>17)+n|0,e+=(n^(o|~r))+h[13]+1309151649|0,e=(e<<21|e>>>11)+o|0,r+=(o^(e|~n))+h[4]-145523070|0,r=(r<<6|r>>>26)+e|0,n+=(e^(r|~o))+h[11]-1120210379|0,n=(n<<10|n>>>22)+r|0,o+=(r^(n|~e))+h[2]+718787259|0,o=(o<<15|o>>>17)+n|0,e+=(n^(o|~r))+h[9]-343485551|0,e=(e<<21|e>>>11)+o|0,f[0]=r+f[0]|0,f[1]=e+f[1]|0,f[2]=o+f[2]|0,f[3]=n+f[3]|0}function u(f){var h=[],r;for(r=0;r<64;r+=4)h[r>>2]=f.charCodeAt(r)+(f.charCodeAt(r+1)<<8)+(f.charCodeAt(r+2)<<16)+(f.charCodeAt(r+3)<<24);return h}function d(f){var h=[],r;for(r=0;r<64;r+=4)h[r>>2]=f[r]+(f[r+1]<<8)+(f[r+2]<<16)+(f[r+3]<<24);return h}function l(f){var h=f.length,r=[1732584193,-271733879,-1732584194,271733878],e,o,n,R,D,A;for(e=64;e<=h;e+=64)i(r,u(f.substring(e-64,e)));for(f=f.substring(e-64),o=f.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<o;e+=1)n[e>>2]|=f.charCodeAt(e)<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(i(r,n),e=0;e<16;e+=1)n[e]=0;return R=h*8,R=R.toString(16).match(/(.*?)(.{0,8})$/),D=parseInt(R[2],16),A=parseInt(R[1],16)||0,n[14]=D,n[15]=A,i(r,n),r}function p(f){var h=f.length,r=[1732584193,-271733879,-1732584194,271733878],e,o,n,R,D,A;for(e=64;e<=h;e+=64)i(r,d(f.subarray(e-64,e)));for(f=e-64<h?f.subarray(e-64):new Uint8Array(0),o=f.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<o;e+=1)n[e>>2]|=f[e]<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(i(r,n),e=0;e<16;e+=1)n[e]=0;return R=h*8,R=R.toString(16).match(/(.*?)(.{0,8})$/),D=parseInt(R[2],16),A=parseInt(R[1],16)||0,n[14]=D,n[15]=A,i(r,n),r}function g(f){var h="",r;for(r=0;r<4;r+=1)h+=s[f>>r*8+4&15]+s[f>>r*8&15];return h}function v(f){var h;for(h=0;h<f.length;h+=1)f[h]=g(f[h]);return f.join("")}v(l("hello"))!=="5d41402abc4b2a76b9719d911017c592"&&(t=function(f,h){var r=(f&65535)+(h&65535),e=(f>>16)+(h>>16)+(r>>16);return e<<16|r&65535}),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function f(h,r){return h=h|0||0,h<0?Math.max(h+r,0):Math.min(h,r)}ArrayBuffer.prototype.slice=function(h,r){var e=this.byteLength,o=f(h,e),n=e,R,D,A,nt;return r!==c&&(n=f(r,e)),o>n?new ArrayBuffer(0):(R=n-o,D=new ArrayBuffer(R),A=new Uint8Array(D),nt=new Uint8Array(this,o,R),A.set(nt),D)}}();function m(f){return/[\u0080-\uFFFF]/.test(f)&&(f=unescape(encodeURIComponent(f))),f}function _(f,h){var r=f.length,e=new ArrayBuffer(r),o=new Uint8Array(e),n;for(n=0;n<r;n+=1)o[n]=f.charCodeAt(n);return h?o:e}function w(f){return String.fromCharCode.apply(null,new Uint8Array(f))}function S(f,h,r){var e=new Uint8Array(f.byteLength+h.byteLength);return e.set(new Uint8Array(f)),e.set(new Uint8Array(h),f.byteLength),r?e:e.buffer}function y(f){var h=[],r=f.length,e;for(e=0;e<r-1;e+=2)h.push(parseInt(f.substr(e,2),16));return String.fromCharCode.apply(String,h)}function b(){this.reset()}return b.prototype.append=function(f){return this.appendBinary(m(f)),this},b.prototype.appendBinary=function(f){this._buff+=f,this._length+=f.length;var h=this._buff.length,r;for(r=64;r<=h;r+=64)i(this._hash,u(this._buff.substring(r-64,r)));return this._buff=this._buff.substring(r-64),this},b.prototype.end=function(f){var h=this._buff,r=h.length,e,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n;for(e=0;e<r;e+=1)o[e>>2]|=h.charCodeAt(e)<<(e%4<<3);return this._finish(o,r),n=v(this._hash),f&&(n=y(n)),this.reset(),n},b.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},b.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},b.prototype.setState=function(f){return this._buff=f.buff,this._length=f.length,this._hash=f.hash,this},b.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},b.prototype._finish=function(f,h){var r=h,e,o,n;if(f[r>>2]|=128<<(r%4<<3),r>55)for(i(this._hash,f),r=0;r<16;r+=1)f[r]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(e[2],16),n=parseInt(e[1],16)||0,f[14]=o,f[15]=n,i(this._hash,f)},b.hash=function(f,h){return b.hashBinary(m(f),h)},b.hashBinary=function(f,h){var r=l(f),e=v(r);return h?y(e):e},b.ArrayBuffer=function(){this.reset()},b.ArrayBuffer.prototype.append=function(f){var h=S(this._buff.buffer,f,!0),r=h.length,e;for(this._length+=f.byteLength,e=64;e<=r;e+=64)i(this._hash,d(h.subarray(e-64,e)));return this._buff=e-64<r?new Uint8Array(h.buffer.slice(e-64)):new Uint8Array(0),this},b.ArrayBuffer.prototype.end=function(f){var h=this._buff,r=h.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o,n;for(o=0;o<r;o+=1)e[o>>2]|=h[o]<<(o%4<<3);return this._finish(e,r),n=v(this._hash),f&&(n=y(n)),this.reset(),n},b.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},b.ArrayBuffer.prototype.getState=function(){var f=b.prototype.getState.call(this);return f.buff=w(f.buff),f},b.ArrayBuffer.prototype.setState=function(f){return f.buff=_(f.buff,!0),b.prototype.setState.call(this,f)},b.ArrayBuffer.prototype.destroy=b.prototype.destroy,b.ArrayBuffer.prototype._finish=b.prototype._finish,b.ArrayBuffer.hash=function(f,h){var r=p(new Uint8Array(f)),e=v(r);return h?y(e):e},b})});var z=Ct(ct(),1),Tt=32768,W=(c,t)=>z.default.hash(c,t),ht=async(c,t)=>{let s=Math.min(Tt,c.size),a=Math.ceil(c.size/s),i=new z.default.ArrayBuffer;for(let u=0;u<a;u++){let l=await c.slice(u*s,(u+1)*s).arrayBuffer();i.append(l)}return i.end(t)},N=()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));var $t=async(c,t)=>W(`${c}${t}`),Ut=(c,t)=>c.sessionId&&c.sessionId===t.sessionId&&c.sourceLastSeq&&c.sourceLastSeq===t.sourceLastSeq?c.sourceLastSeq:null,ut=(c,t)=>{if(!c)return-1;if(!t)return 1;if(c===t)return 0;let s=parseInt(c,10),a=parseInt(t,10);return s-a},L=class extends TransformStream{constructor({batchSize:t}){super({transform(s,a){if(this.entries.push(s),this.entries.length>=t){let i=this.entries.splice(0,t);a.enqueue(i)}},flush(s){this.entries.length>0&&s.enqueue(this.entries)},entries:[]},{highWaterMark:1024*4},{highWaterMark:1024*4})}},H=class extends TransformStream{constructor(t){super({transform(s,a){console.debug(t,s.length,s),a.enqueue(s)}},{highWaterMark:1024*4},{highWaterMark:1024*4})}},dt=async(c,t,{batchSize:s={source:1024,target:256}}={})=>{let a=N(),i={docsRead:0,docsWritten:0},[{uuid:u},{uuid:d,updateSeq:l}]=await Promise.all([t.replicator.getInfo(),c.replicator.getInfo()]),p=await $t(u,d),[g,v]=await Promise.all([t.replicator.getLog(p),c.replicator.getLog(p)]),m=Ut(g,v);if(ut(m,l)===0)return i;let _=!1;for(;!_;){let w={};if(await c.replicator.getChanges(m,{limit:s.source},w).pipeThrough(new L({batchSize:s.target})).pipeThrough(t.replicator.getDiff()).pipeThrough(new L({batchSize:s.source})).pipeThrough(new H("got diffs now getRevs")).pipeThrough(c.replicator.getRevs(w)).pipeThrough(new L({batchSize:s.target})).pipeTo(t.replicator.saveRevs(w)),i.lastSeq=w.lastSeq,i.docsRead+=w.docsRead,i.docsWritten+=w.docsWritten,w.lastSeq!==m){v.sessionId=a,v.sourceLastSeq=w.lastSeq,g.sessionId=a,g.sourceLastSeq=w.lastSeq;let[{rev:S},{rev:y}]=await Promise.all([t.replicator.saveLog(g),c.replicator.saveLog(v)]);g._rev=S,v._rev=y}m=w.lastSeq,_=w.numberOfChanges<s.source||ut(w.lastSeq,l)>=0}return i},I=class extends EventTarget{constructor(){super(),this.replicator=null}async init(){throw new Error(`init is not implemented for ${this.constructor.name}`)}async destroy(){throw new Error(`destroy is not implemented for ${this.constructor.name}`)}async getChanges(t){throw new Error(`getChanges is not implemented for ${this.constructor.name}`)}async getDoc(t){throw new Error(`getDoc is not implemented for ${this.constructor.name}`)}async saveDoc(t){throw new Error(`saveDoc is not implemented for ${this.constructor.name}`)}async deleteDoc(t){throw new Error(`deleteDoc is not implemented for ${this.constructor.name}`)}async getDocs(t){throw new Error(`getDocs is not implemented for ${this.constructor.name}`)}async pull(t,s){let a=await dt(t,this,s);return a.docsWritten>0&&this.dispatchEvent(new Event("change")),a}push(t,s){return dt(this,t,s)}sync(t){return Promise.all([this.pull(t),this.push(t)])}};var C=class extends I{constructor({name:t}){super(),this.name=t,this.adapter=null,this.replicator=null}init(){return this.adapter.init()}destroy(){return this.adapter.destroy()}async saveDoc(t){let[s]=await this.adapter.saveDocs([t]);return this.dispatchEvent(new Event("change")),s}};var T=class{constructor({name:t}){this.name=t,this.db=null,this.metadata=null}destroy(){return new Promise((t,s)=>{this.db.close();let a=indexedDB.deleteDatabase(this.name);a.onsuccess=()=>{this.db=null,this.metadata=null,t()}})}};function pt(c){for(var t,s,a,i=c.rev_tree.slice(),u;u=i.pop();){var d=u.ids,l=d[2],p=u.pos;if(l.length){for(var g=0,v=l.length;g<v;g++)i.push({pos:p+1,ids:l[g]});continue}var m=!!d[1].deleted,_=d[0];(!t||(a!==m?a:s!==p?s<p:t<_))&&(t=_,s=p,a=m)}return s+"-"+t}function vt(c,t){for(var s=c.slice(),a;a=s.pop();)for(var i=a.pos,u=a.ids,d=u[2],l=t(d.length===0,i,u[0],a.ctx,u[1]),p=0,g=d.length;p<g;p++)s.push({pos:i+1,ids:d[p],ctx:l})}function gt(c){var t=[];return vt(c.rev_tree,function(s,a,i,u,d){d.status==="available"&&!s&&(t.push(a+"-"+i),d.status="missing")}),t}function V(c){for(var t=[],s=c.slice(),a;a=s.pop();){var i=a.pos,u=a.ids,d=u[0],l=u[1],p=u[2],g=p.length===0,v=a.history?a.history.slice():[];v.push({id:d,opts:l}),g&&t.push({pos:i+1-v.length,ids:v});for(var m=0,_=p.length;m<_;m++)s.push({pos:i+1,ids:p[m],history:v})}return t.reverse()}function Bt(c,t){return c.pos-t.pos}function Pt(c,t,s){for(var a=0,i=c.length,u;a<i;)u=a+i>>>1,s(c[u],t)<0?a=u+1:i=u;return a}function Ft(c,t,s){var a=Pt(c,t,s);c.splice(a,0,t)}function ft(c,t){for(var s,a,i=t,u=c.length;i<u;i++){var d=c[i],l=[d.id,d.opts,[]];a?(a[2].push(l),a=l):s=a=l}return s}function jt(c,t){return c[0]<t[0]?-1:1}function lt(c,t){for(var s=[{tree1:c,tree2:t}],a=!1;s.length>0;){var i=s.pop(),u=i.tree1,d=i.tree2;(u[1].status||d[1].status)&&(u[1].status=u[1].status==="available"||d[1].status==="available"?"available":"missing");for(var l=0;l<d[2].length;l++){if(!u[2][0]){a="new_leaf",u[2][0]=d[2][l];continue}for(var p=!1,g=0;g<u[2].length;g++)u[2][g][0]===d[2][l][0]&&(s.push({tree1:u[2][g],tree2:d[2][l]}),p=!0);p||(a="new_branch",Ft(u[2],d[2][l],jt))}}return{conflicts:a,tree:c}}function mt(c,t,s){var a=[],i=!1,u=!1,d;if(!c.length)return{tree:[t],conflicts:"new_leaf"};for(var l=0,p=c.length;l<p;l++){var g=c[l];if(g.pos===t.pos&&g.ids[0]===t.ids[0])d=lt(g.ids,t.ids),a.push({pos:g.pos,ids:d.tree}),i=i||d.conflicts,u=!0;else if(s!==!0){var v=g.pos<t.pos?g:t,m=g.pos<t.pos?t:g,_=m.pos-v.pos,w=[],S=[];for(S.push({ids:v.ids,diff:_,parent:null,parentIdx:null});S.length>0;){var y=S.pop();if(y.diff===0){y.ids[0]===m.ids[0]&&w.push(y);continue}for(var b=y.ids[2],f=0,h=b.length;f<h;f++)S.push({ids:b[f],diff:y.diff-1,parent:y.ids,parentIdx:f})}var r=w[0];r?(d=lt(r.ids,m.ids),r.parent[2][r.parentIdx]=d.tree,a.push({pos:v.pos,ids:v.ids}),i=i||d.conflicts,u=!0):a.push(g)}else a.push(g)}return u||a.push(t),a.sort(Bt),{tree:a,conflicts:i||"internal_node"}}function Mt(c,t){for(var s=V(c),a,i,u=0,d=s.length;u<d;u++){var l=s[u],p=l.ids,g;if(p.length>t){a||(a={});var v=p.length-t;g={pos:l.pos+v,ids:ft(p,v)};for(var m=0;m<v;m++){var _=l.pos+m+"-"+p[m].id;a[_]=!0}}else g={pos:l.pos,ids:ft(p,0)};i?i=mt(i,g,!0).tree:i=[g]}return a&&vt(i,function(w,S,y){delete a[S+"-"+y]}),{tree:i,revs:a?Object.keys(a):[]}}function wt(c,t,s){var a=mt(c,t),i=Mt(a.tree,s);return{tree:i.tree,stemmedRevs:i.revs,conflicts:a.conflicts}}var Ot=1e3,Z={status:"available"},yt={status:"missing"},Wt=c=>W(JSON.stringify(c)),Nt=c=>{let[t,s]=c.split("-");return[parseInt(t,10),s]},Vt=c=>{let t={};for(let s in c)s.startsWith("_")||(t[s]=c[s]);if(c._attachments){t._attachments={};for(let s in c._attachments){let{digest:a,revpos:i}=c._attachments[s];t._attachments[s]={digest:a,revpos:i}}}return t},Jt=(c,t)=>{let s=c.split("-"),a=parseInt(s[0],10),i=s[1],u=V(t),d=null;for(var l=0;l<u.length;l++){let v=u[l],m=v.ids.map(({id:w})=>w).indexOf(i);(m===a-1||!d&&m!==-1)&&(d=v)}if(!d)throw new Error("invalid rev tree");let p=d.ids.map(({id:v})=>v).indexOf(i)+1,g=d.ids.length-p;return d.ids.splice(p,g),d.ids.reverse(),{start:d.pos+d.ids.length-1,ids:d.ids.map(({id:v})=>v)}},bt=c=>({id:c,tree:[],attachments:{},revs:{}}),_t=(c,t,{newEdits:s})=>{for(let{doc:a}of t){let{_id:i,_rev:u,_deleted:d,_attachments:l,_revisions:p}=a,g=Vt(a),v,m,_;if(s){let h=Wt({...g,_id:i,_rev:u,_deleted:d}),r=s&&c.deleted;if(u||r){let e=r?c.rev:u,[o,n]=Nt(e);m=o+1,_=[{pos:o,ids:[n,yt,[[h,Z,[]]]]}]}else m=1,_=[{pos:1,ids:[h,Z,[]]}];v=`${m}-${h}`}else{if(!p)throw new Error("missing _revisions");m=p.start;let h=m-p.ids.length+1,r=[p.ids[0],Z,[]];for(let e=1,o=p.ids.length;e<o;e++)r=[p.ids[e],yt,[r]];v=u,_=[{pos:h,ids:r}]}let{tree:w,stemmedRevs:S}=wt(c.tree,_[0],Ot);c.tree=w,c.revs[v]={data:g,deleted:!!d};let y=pt({rev_tree:w});if(c.rev=y,c.deleted=c.revs[y].deleted,l)for(let h in l){let r=l[h],{stub:e,data:o,digest:n}=r;if(!n)throw new Error("missing attachment digest");if(e){if(!(n in c.attachments))throw new Error("missing attachment data for stub");c.attachments[n].revs[v]=!0}else n in c.attachments?c.attachments[n].revs[v]=!0:(g._attachments[h].revpos=m,c.attachments[n]={data:o,revs:{[v]:!0}})}let f=gt({rev_tree:w}).concat(S);for(let h of f){delete c.revs[h];for(let r in c.attachments){let e=c.attachments[r].revs;delete e[h],Object.keys(e).length===0&&delete c.attachments[r]}}}return c.available=Object.keys(c.revs).map(a=>[c.id,a]),c},St=(c,t)=>{let{id:s,tree:a,revs:i,attachments:u}=c;if(!(t in i))throw new Error(`rev not found: '${s}@${t.rev}'`);let{data:d,deleted:l}=i[t],p=Jt(t,a);if(d._attachments)for(let g in d._attachments){let v=d._attachments[g],m=u[v.digest].data;v.data=m,v.content_type=m.type,v.length=m.size}return{...d,_id:s,_rev:t,_deleted:l,_revisions:p}},Rt=({id:c,rev:t,seq:s,deleted:a,tree:i})=>{let d=V(i).map(({pos:l,ids:p})=>({rev:`${l+p.length-1}-${p.pop().id}`}));return{seq:s,id:c,changes:d,deleted:a}};var x="docs",E="meta",Kt=async c=>{let t=await ht(c,!0);return`md5-${btoa(t)}`},$=class extends T{constructor({name:t}){super({name:t})}async init(){if(!this.db)return new Promise((t,s)=>{let a=indexedDB.open(this.name);a.onerror=i=>s(i.target.error),a.onblocked=i=>s(i),a.onupgradeneeded=i=>{let u=i.target.result,d="id",l=u.createObjectStore(x,{keyPath:d});l.createIndex("seq","seq",{unique:!0}),l.createIndex("revs","available",{multiEntry:!0}),u.createObjectStore(E,{keyPath:d})},a.onsuccess=i=>{this.db=i.target.result,this.db.onabort=()=>this.db.close(),this.db.onversionchange=()=>this.db.close();let u=this.db.transaction(E,"readwrite");u.oncomplete=()=>t();let d=u.objectStore(E);d.get(E).onsuccess=l=>{if(!l.target.result){let p={id:E,doc_count:0,seq:0,db_uuid:N()};d.put(p)}}}})}getMetadata(){return new Promise((t,s)=>{let a=this.db.transaction(E,"readonly");a.onerror=i=>s(i),a.objectStore(E).get(E).onsuccess=i=>t(i.target.result)})}getLocalDoc(t){let s=`_local/${t}`;return new Promise((a,i)=>{let u=this.db.transaction(x,"readonly");u.onerror=d=>i(d),u.objectStore(x).get(s).onsuccess=d=>{let l=d.target.result,p=l?l.data:{_id:s};a(p)}})}saveLocalDoc(t){let s={id:t._id,data:{...t,_rev:t._rev?t._rev+1:1}};return new Promise((a,i)=>{let u=this.db.transaction(x,"readwrite");u.onerror=d=>i(d),u.objectStore(x).put(s).onsuccess=()=>a({rev:t._rev})})}async getDiff(t){return new Promise((s,a)=>{let i=this.db.transaction(x,"readonly");i.onerror=l=>a(l);let u=i.objectStore(x).index("revs"),d=[];i.oncomplete=()=>{let l=d.filter(({revs:p})=>p.length>0);s(l)};for(let{id:l,revs:p}of t){let g={id:l,revs:[]};for(let{rev:v}of p)u.getKey([l,v]).onsuccess=m=>{m.target.result||g.revs.push({rev:v})};d.push(g)}})}async getRevs(t){return new Promise((s,a)=>{let i=this.db.transaction(x,"readonly");i.onerror=d=>a(d);let u=i.objectStore(x);i.oncomplete=()=>s(t);for(let d of t){let{id:l,revs:p}=d;u.get(l).onsuccess=g=>{let v=g.target.result;if(!v)throw new Error(`doc not found: '${l}'`);for(let m of p)m.doc=St(v,m.rev)}}})}async saveDocs(t){let s=t.map(a=>({id:a._id,revs:[{doc:a}]}));return this.saveRevs(s,{newEdits:!0})}async saveRevs(t,{newEdits:s}){for(let{id:a,revs:i}of t)for(let{doc:{_attachments:u}}of i)if(!!u)for(let d in u){let l=u[d],{data:p}=l;!p||(l.digest=await Kt(p))}return new Promise((a,i)=>{let u=this.db.transaction([x,E],"readwrite");u.onerror=g=>i(g);let d=[];u.oncomplete=()=>a(d);let l=u.objectStore(x),p=u.objectStore(E);p.get(E).onsuccess=g=>{let v=g.target.result,m=t.length;for(let{id:_,revs:w}of t)l.get(_).onsuccess=S=>{let y=S.target.result,b=!y,f=y&&y.deleted,h=y||bt(_),r=_t(h,w,{newEdits:s});r.seq=++v.seq;let e=r.deleted;l.put(r).onsuccess=()=>{d.docsWritten++;let o=0;b?o=1:(!f&&e&&(o=-1),f&&!e&&(o=1)),v.doc_count+=o,d.push({id:_,rev:r.rev}),m--,m===0&&p.put(v)}}}})}async getChanges({since:t,limit:s}={}){return t=t||-1,s=s||-1,new Promise((a,i)=>{let u=this.db.transaction(x,"readonly");u.onerror=v=>i(v);let d=u.objectStore(x).index("seq"),l=[],p=-1,g=0;d.openCursor(IDBKeyRange.lowerBound(t,!0)).onsuccess=v=>{if(!v.target.result)return;let m=v.target.result,_=m.value,w=Rt(_);l.push(w),p=w.seq,g++,g!==s&&m.continue()},u.oncomplete=()=>a({changes:l,lastSeq:p})})}};var q=class{async getInfo(){throw new Error(`getInfo is not implemented for ${this.constructor.name}`)}async getLog(t){throw new Error(`getLog is not implemented for ${this.constructor.name}`)}async saveLog(t){throw new Error(`saveLog is not implemented for ${this.constructor.name}`)}getChanges(t,{limit:s}={},a={}){throw new Error(`getChanges is not implemented for ${this.constructor.name}`)}getDiff(){throw new Error(`getDiff is not implemented for ${this.constructor.name}`)}getRevs(t={}){throw new Error(`getRevs is not implemented for ${this.constructor.name}`)}saveRevs(t={}){throw new Error(`saveRevs is not implemented for ${this.constructor.name}`)}};var Q=class extends ReadableStream{constructor(t,{since:s,limit:a},i={}){let u;super({async start(d){let l=await t.getChanges({since:s,limit:a});u=l.changes,i.numberOfChanges=u.length,i.lastSeq=l.lastSeq},pull(d){if(u.length===0){d.close();return}let{id:l,changes:p}=u.shift();d.enqueue({id:l,revs:p})}})}},X=class extends TransformStream{constructor(t){super({async transform(s,a){let i=s.map(({id:d})=>d),u=await t.getDiff(s);for(let d of u)a.enqueue(d)}},{highWaterMark:8},{highWaterMark:1024})}},Y=class extends TransformStream{constructor(t,s){s.docsRead=0,super({async transform(a,i){if(a.length===0)return;let u=await t.getRevs(a);for(let d of u)s.docsRead++,i.enqueue(d)}},{highWaterMark:8})}},G=class extends WritableStream{constructor(t,s={}){s.docsWritten=0,super({async write(a){let i=await t.saveRevs(a,{newEdits:!1});s.docsWritten+=i.length}},{highWaterMark:1024*4})}},U=class extends q{constructor(t){super(),this.adapter=t}async getInfo(){let{db_uuid:t,seq:s}=await this.adapter.getMetadata();return{uuid:t,updateSeq:s}}getLog(t){return this.adapter.getLocalDoc(t)}saveLog(t){return this.adapter.saveLocalDoc(t)}getChanges(t,{limit:s}={},a={}){return new Q(this.adapter,{since:t,limit:s},a)}getDiff(){return new X(this.adapter)}getRevs(t={}){return new Y(this.adapter,t)}saveRevs(t={}){return new G(this.adapter,t)}};var J=class extends C{constructor({name:t}){super({name:t}),this.adapter=new $({name:t}),this.replicator=new U(this.adapter)}};var B=class extends I{constructor(){super()}async getDoc(t){return(await this.adapter.getDoc(t)).json()}async saveDoc(t){let s=await this.adapter.saveDoc(t);return this.dispatchEvent(new Event("change")),s.json()}async deleteDoc(t){let s=await this.adapter.deleteDoc(t);return this.dispatchEvent(new Event("change")),s.json()}};var P=class{constructor({url:t,headers:s}){this.url=t,this.root=t.pathname,this.headers=s}async getServerInfo(){let t=new URL(this.url);t.pathname="/";let s=await fetch(t,{headers:this.headers});if(s.status!==200)throw new Error("Remote server not reachable");return s.json()}async getInfo(){let t=new URL(this.url),s=await fetch(t,{headers:this.headers});if(s.status!==200)throw new Error("Remote database not reachable");return s.json()}async getDoc(t){let s=new URL(`${this.root}/${t}`,this.url),a=await fetch(s,{headers:this.headers});if(a.status!==200)throw new Error("Could not get doc");return a}async saveDoc(t){let s=new URL(`${this.root}/${t._id}`,this.url),a=JSON.stringify(t),i=await fetch(s,{headers:{...this.headers,"Content-Type":"application/json"},method:"put",body:a});if(i.status!==201)throw new Error("Could not save doc");return i}async deleteDoc(t){let s=new URL(`${this.root}/${t._id}`,this.url);s.searchParams.set("rev",t._rev);let a=await fetch(s,{headers:{...this.headers},method:"delete"});if(a.status!==200)throw new Error("Could not delete doc");return a}async getChanges(t,{limit:s}={}){let a=new URL(`${this.root}/_changes`,this.url);a.searchParams.set("feed","continuous"),a.searchParams.set("timeout","0"),a.searchParams.set("style","all_docs"),t&&a.searchParams.set("since",t),s&&(a.searchParams.set("limit",s),a.searchParams.set("seq_interval",s));let i=await fetch(a,{headers:this.headers});if(i.status!==200)throw new Error("Could not get changes");return i}async revsDiff(t){let s=new URL(`${this.root}/_revs_diff`,this.url),a=JSON.stringify(t),i=await fetch(s,{headers:{...this.headers,"Content-Type":"application/json"},method:"post",body:a});if(i.status!==200)throw new Error("Could not get revs diff");return i}async bulkDocs(t){let s=new URL(`${this.root}/_bulk_docs`,this.url),a=JSON.stringify({docs:t,new_edits:!1}),i=await fetch(s,{headers:{...this.headers,"Content-Type":"application/json"},method:"post",body:a});if(i.status!==201)throw new Error("Could not save bulk docs");return i}};var F=class extends P{constructor({url:t,headers:s}){super({url:t,headers:s})}async bulkGet(t){let s=new URL(`${this.root}/_bulk_get`,this.url);s.searchParams.set("revs","true"),s.searchParams.set("attachments","true");let a=JSON.stringify({docs:t}),i=await fetch(s,{headers:{...this.headers,"Content-Type":"application/json"},method:"post",body:a});if(i.status!==200)throw new Error("Could not get docs multipart");return i}};var k=class extends ReadableStream{constructor(t,{since:s,limit:a}){let i;super({async start(u){i=(await t.getChanges(s,{limit:a})).body.getReader()},async pull(u){let{done:d,value:l}=await i.read();d?(u.close(),i.releaseLock()):u.enqueue(l)}},{highWaterMark:1024*1024})}},zt=c=>{for(let t=0;t<c.length;t++)if(c[t]===10)return t;return-1},tt=class extends TransformStream{constructor(t={}){t.numberOfChanges=0,t.lastSeq=null;let s=new TextDecoder;super({transform(a,i){let u=new Uint8Array(this.data.length+a.length);for(u.set(this.data,0),u.set(a,this.data.length),this.data=u;;){let d=zt(this.data);if(d===-1)return;if(d>0){let l=s.decode(this.data.slice(0,d)),p;try{p=JSON.parse(l)}catch{throw new Error("could not parse change JSON")}let{last_seq:g,id:v,changes:m}=p;g?t.lastSeq=g:(t.numberOfChanges++,i.enqueue({id:v,revs:m}))}this.data=this.data.slice(d+1)}},data:new Uint8Array(0),startParsed:!1},{highWaterMark:1024*1024*8},{highWaterMark:1024})}},et=class extends TransformStream{constructor(t){super({async transform(s,a){let i={};for(let{id:l,revs:p}of s)i[l]=p.map(({rev:g})=>g);let d=await(await t.revsDiff(i)).json();for(let l in d){if(!("missing"in d[l]))throw new Error("missing `missing` property in revsDiff response");let{missing:p}=d[l],g=p.map(v=>({rev:v}));g.length>0&&a.enqueue({id:l,revs:g})}}})}},j=class extends q{constructor(t){super(),this.adapter=t}async getInfo(){let[{uuid:t},{update_seq:s}]=await Promise.all([this.adapter.getServerInfo(),this.adapter.getInfo()]);return{uuid:t,updateSeq:s}}async getLog(t){let s=`_local/${t}`,a;try{a=await(await this.adapter.getDoc(s)).json()}catch{a={_id:s}}return a}async saveLog(t){return(await this.adapter.saveDoc(t)).json()}getChanges(t,{limit:s}={},a={}){let i=new k(this.adapter,{since:t,limit:s}),u=new tt(a);return i.pipeThrough(u)}getDiff(){return new et(this.adapter)}};var M=class{constructor(){this.decoder=new TextDecoder,this.data=new Uint8Array(0),this.objectLevel=0,this.onDoc=void 0}async write(t){if(t){let l=new Uint8Array(this.data.length+t.length);l.set(this.data,0),l.set(t,this.data.length),this.data=l}let s=0+this.objectLevel,a=-1,i=-1,u=!1,d=!1;for(let l=0;l<this.data.length;l++)if(this.data[l]===34&&!d&&(u=!u),d=u&&this.data[l]===92,!u&&(this.data[l]===123&&(s++,s===2&&(a=l)),this.data[l]===125)){if(s===2){let p=this.decoder.decode(this.data.slice(a,l+1)),g=JSON.parse(p);await this.onDoc(g),a=-1,i=l+1}s--}i>-1?(this.data=this.data.slice(i),this.objectLevel=1):a>-1&&(this.data=this.data.slice(a),this.objectLevel=1)}};var Ht=(c,t)=>{let s=atob(c),a=s.length,i=new Uint8Array(a);for(let u=0;u<a;++u)i[u]=s.charCodeAt(u);return new Blob([i],{type:t})},Zt=c=>new Promise((t,s)=>{let a=new FileReader;a.onloadend=()=>{let i=`data:${c.type};base64,`,u=a.result.slice(i.length);t(u)},a.readAsDataURL(c)}),rt=class extends TransformStream{constructor(t,s){s.docsRead=0,super({async transform(a,i){if(a.length===0)return;let u=[],d={};for(let v of a){let{id:m,revs:_}=v;d[m]=v;for(let{rev:w}of _)u.push({id:m,rev:w})}if(u.length===0)throw new Error("received messages with empty revs");let p=(await t.bulkGet(u)).body.getReader(),g=new M;for(g.onDoc=async v=>{let{id:m,docs:_}=v;if(!(m in d))throw console.log(v),new Error("recived doc which we did not ask for");let w={};for(let{ok:y}of _)if(w[y._rev]=y,y._attachments)for(let b in y._attachments){let f=y._attachments[b],{data:h,content_type:r}=f;f.data=await Ht(h,r)}let S=d[m];for(let y of S.revs)y.rev in w&&(y.doc=w[y.rev]);i.enqueue(S),s.docsRead++};;){let{done:v,value:m}=await p.read();if(v)break;await g.write(m)}}},{highWaterMark:8},{highWaterMark:1024*4})}},st=class extends WritableStream{constructor(t,s={}){s.docsWritten=0,super({async write(a){let i=a.reduce((u,{revs:d})=>u.concat(d.map(({doc:l})=>l)),[]);if(i.length>0){for(let d of i)if(d._attachments)for(let l in d._attachments){let p=d._attachments[l],{data:g}=p;p.data=await Zt(g)}let u=await t.bulkDocs(i)}s.docsWritten+=a.length}})}},O=class extends j{constructor(t){super(),this.adapter=t}getRevs(t={}){return new rt(this.adapter,t)}saveRevs(t={}){return new st(this.adapter,t)}};var K=class extends B{constructor({url:t,headers:s}){super(),this.adapter=new F({url:t,headers:s}),this.replicator=new O(this.adapter)}};export{K as HttpInlineDatabase,J as IndexedDbFlatDatabase};
