var gt=Object.create;var X=Object.defineProperty;var vt=Object.getOwnPropertyDescriptor;var mt=Object.getOwnPropertyNames;var yt=Object.getPrototypeOf,wt=Object.prototype.hasOwnProperty;var _t=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var bt=(a,t,o,c)=>{if(t&&typeof t=="object"||typeof t=="function")for(let u of mt(t))!wt.call(a,u)&&u!==o&&X(a,u,{get:()=>t[u],enumerable:!(c=vt(t,u))||c.enumerable});return a};var N=(a,t,o)=>(o=a!=null?gt(yt(a)):{},bt(t||!a||!a.__esModule?X(o,"default",{value:a,enumerable:!0}):o,a));var $=_t((Y,k)=>{(function(a){if(typeof Y=="object")k.exports=a();else if(typeof define=="function"&&define.amd)define(a);else{var t;try{t=window}catch{t=self}t.SparkMD5=a()}})(function(a){"use strict";var t=function(l,i){return l+i&4294967295},o=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function c(l,i,r,e,n,s){return i=t(t(i,l),t(e,s)),t(i<<n|i>>>32-n,r)}function u(l,i){var r=l[0],e=l[1],n=l[2],s=l[3];r+=(e&n|~e&s)+i[0]-680876936|0,r=(r<<7|r>>>25)+e|0,s+=(r&e|~r&n)+i[1]-389564586|0,s=(s<<12|s>>>20)+r|0,n+=(s&r|~s&e)+i[2]+606105819|0,n=(n<<17|n>>>15)+s|0,e+=(n&s|~n&r)+i[3]-1044525330|0,e=(e<<22|e>>>10)+n|0,r+=(e&n|~e&s)+i[4]-176418897|0,r=(r<<7|r>>>25)+e|0,s+=(r&e|~r&n)+i[5]+1200080426|0,s=(s<<12|s>>>20)+r|0,n+=(s&r|~s&e)+i[6]-1473231341|0,n=(n<<17|n>>>15)+s|0,e+=(n&s|~n&r)+i[7]-45705983|0,e=(e<<22|e>>>10)+n|0,r+=(e&n|~e&s)+i[8]+1770035416|0,r=(r<<7|r>>>25)+e|0,s+=(r&e|~r&n)+i[9]-1958414417|0,s=(s<<12|s>>>20)+r|0,n+=(s&r|~s&e)+i[10]-42063|0,n=(n<<17|n>>>15)+s|0,e+=(n&s|~n&r)+i[11]-1990404162|0,e=(e<<22|e>>>10)+n|0,r+=(e&n|~e&s)+i[12]+1804603682|0,r=(r<<7|r>>>25)+e|0,s+=(r&e|~r&n)+i[13]-40341101|0,s=(s<<12|s>>>20)+r|0,n+=(s&r|~s&e)+i[14]-1502002290|0,n=(n<<17|n>>>15)+s|0,e+=(n&s|~n&r)+i[15]+1236535329|0,e=(e<<22|e>>>10)+n|0,r+=(e&s|n&~s)+i[1]-165796510|0,r=(r<<5|r>>>27)+e|0,s+=(r&n|e&~n)+i[6]-1069501632|0,s=(s<<9|s>>>23)+r|0,n+=(s&e|r&~e)+i[11]+643717713|0,n=(n<<14|n>>>18)+s|0,e+=(n&r|s&~r)+i[0]-373897302|0,e=(e<<20|e>>>12)+n|0,r+=(e&s|n&~s)+i[5]-701558691|0,r=(r<<5|r>>>27)+e|0,s+=(r&n|e&~n)+i[10]+38016083|0,s=(s<<9|s>>>23)+r|0,n+=(s&e|r&~e)+i[15]-660478335|0,n=(n<<14|n>>>18)+s|0,e+=(n&r|s&~r)+i[4]-405537848|0,e=(e<<20|e>>>12)+n|0,r+=(e&s|n&~s)+i[9]+568446438|0,r=(r<<5|r>>>27)+e|0,s+=(r&n|e&~n)+i[14]-1019803690|0,s=(s<<9|s>>>23)+r|0,n+=(s&e|r&~e)+i[3]-187363961|0,n=(n<<14|n>>>18)+s|0,e+=(n&r|s&~r)+i[8]+1163531501|0,e=(e<<20|e>>>12)+n|0,r+=(e&s|n&~s)+i[13]-1444681467|0,r=(r<<5|r>>>27)+e|0,s+=(r&n|e&~n)+i[2]-51403784|0,s=(s<<9|s>>>23)+r|0,n+=(s&e|r&~e)+i[7]+1735328473|0,n=(n<<14|n>>>18)+s|0,e+=(n&r|s&~r)+i[12]-1926607734|0,e=(e<<20|e>>>12)+n|0,r+=(e^n^s)+i[5]-378558|0,r=(r<<4|r>>>28)+e|0,s+=(r^e^n)+i[8]-2022574463|0,s=(s<<11|s>>>21)+r|0,n+=(s^r^e)+i[11]+1839030562|0,n=(n<<16|n>>>16)+s|0,e+=(n^s^r)+i[14]-35309556|0,e=(e<<23|e>>>9)+n|0,r+=(e^n^s)+i[1]-1530992060|0,r=(r<<4|r>>>28)+e|0,s+=(r^e^n)+i[4]+1272893353|0,s=(s<<11|s>>>21)+r|0,n+=(s^r^e)+i[7]-155497632|0,n=(n<<16|n>>>16)+s|0,e+=(n^s^r)+i[10]-1094730640|0,e=(e<<23|e>>>9)+n|0,r+=(e^n^s)+i[13]+681279174|0,r=(r<<4|r>>>28)+e|0,s+=(r^e^n)+i[0]-358537222|0,s=(s<<11|s>>>21)+r|0,n+=(s^r^e)+i[3]-722521979|0,n=(n<<16|n>>>16)+s|0,e+=(n^s^r)+i[6]+76029189|0,e=(e<<23|e>>>9)+n|0,r+=(e^n^s)+i[9]-640364487|0,r=(r<<4|r>>>28)+e|0,s+=(r^e^n)+i[12]-421815835|0,s=(s<<11|s>>>21)+r|0,n+=(s^r^e)+i[15]+530742520|0,n=(n<<16|n>>>16)+s|0,e+=(n^s^r)+i[2]-995338651|0,e=(e<<23|e>>>9)+n|0,r+=(n^(e|~s))+i[0]-198630844|0,r=(r<<6|r>>>26)+e|0,s+=(e^(r|~n))+i[7]+1126891415|0,s=(s<<10|s>>>22)+r|0,n+=(r^(s|~e))+i[14]-1416354905|0,n=(n<<15|n>>>17)+s|0,e+=(s^(n|~r))+i[5]-57434055|0,e=(e<<21|e>>>11)+n|0,r+=(n^(e|~s))+i[12]+1700485571|0,r=(r<<6|r>>>26)+e|0,s+=(e^(r|~n))+i[3]-1894986606|0,s=(s<<10|s>>>22)+r|0,n+=(r^(s|~e))+i[10]-1051523|0,n=(n<<15|n>>>17)+s|0,e+=(s^(n|~r))+i[1]-2054922799|0,e=(e<<21|e>>>11)+n|0,r+=(n^(e|~s))+i[8]+1873313359|0,r=(r<<6|r>>>26)+e|0,s+=(e^(r|~n))+i[15]-30611744|0,s=(s<<10|s>>>22)+r|0,n+=(r^(s|~e))+i[6]-1560198380|0,n=(n<<15|n>>>17)+s|0,e+=(s^(n|~r))+i[13]+1309151649|0,e=(e<<21|e>>>11)+n|0,r+=(n^(e|~s))+i[4]-145523070|0,r=(r<<6|r>>>26)+e|0,s+=(e^(r|~n))+i[11]-1120210379|0,s=(s<<10|s>>>22)+r|0,n+=(r^(s|~e))+i[2]+718787259|0,n=(n<<15|n>>>17)+s|0,e+=(s^(n|~r))+i[9]-343485551|0,e=(e<<21|e>>>11)+n|0,l[0]=r+l[0]|0,l[1]=e+l[1]|0,l[2]=n+l[2]|0,l[3]=s+l[3]|0}function h(l){var i=[],r;for(r=0;r<64;r+=4)i[r>>2]=l.charCodeAt(r)+(l.charCodeAt(r+1)<<8)+(l.charCodeAt(r+2)<<16)+(l.charCodeAt(r+3)<<24);return i}function f(l){var i=[],r;for(r=0;r<64;r+=4)i[r>>2]=l[r]+(l[r+1]<<8)+(l[r+2]<<16)+(l[r+3]<<24);return i}function d(l){var i=l.length,r=[1732584193,-271733879,-1732584194,271733878],e,n,s,b,T,A;for(e=64;e<=i;e+=64)u(r,h(l.substring(e-64,e)));for(l=l.substring(e-64),n=l.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)s[e>>2]|=l.charCodeAt(e)<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(u(r,s),e=0;e<16;e+=1)s[e]=0;return b=i*8,b=b.toString(16).match(/(.*?)(.{0,8})$/),T=parseInt(b[2],16),A=parseInt(b[1],16)||0,s[14]=T,s[15]=A,u(r,s),r}function p(l){var i=l.length,r=[1732584193,-271733879,-1732584194,271733878],e,n,s,b,T,A;for(e=64;e<=i;e+=64)u(r,f(l.subarray(e-64,e)));for(l=e-64<i?l.subarray(e-64):new Uint8Array(0),n=l.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)s[e>>2]|=l[e]<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(u(r,s),e=0;e<16;e+=1)s[e]=0;return b=i*8,b=b.toString(16).match(/(.*?)(.{0,8})$/),T=parseInt(b[2],16),A=parseInt(b[1],16)||0,s[14]=T,s[15]=A,u(r,s),r}function g(l){var i="",r;for(r=0;r<4;r+=1)i+=o[l>>r*8+4&15]+o[l>>r*8&15];return i}function v(l){var i;for(i=0;i<l.length;i+=1)l[i]=g(l[i]);return l.join("")}v(d("hello"))!=="5d41402abc4b2a76b9719d911017c592"&&(t=function(l,i){var r=(l&65535)+(i&65535),e=(l>>16)+(i>>16)+(r>>16);return e<<16|r&65535}),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function l(i,r){return i=i|0||0,i<0?Math.max(i+r,0):Math.min(i,r)}ArrayBuffer.prototype.slice=function(i,r){var e=this.byteLength,n=l(i,e),s=e,b,T,A,Q;return r!==a&&(s=l(r,e)),n>s?new ArrayBuffer(0):(b=s-n,T=new ArrayBuffer(b),A=new Uint8Array(T),Q=new Uint8Array(this,n,b),A.set(Q),T)}}();function m(l){return/[\u0080-\uFFFF]/.test(l)&&(l=unescape(encodeURIComponent(l))),l}function _(l,i){var r=l.length,e=new ArrayBuffer(r),n=new Uint8Array(e),s;for(s=0;s<r;s+=1)n[s]=l.charCodeAt(s);return i?n:e}function y(l){return String.fromCharCode.apply(null,new Uint8Array(l))}function R(l,i,r){var e=new Uint8Array(l.byteLength+i.byteLength);return e.set(new Uint8Array(l)),e.set(new Uint8Array(i),l.byteLength),r?e:e.buffer}function S(l){var i=[],r=l.length,e;for(e=0;e<r-1;e+=2)i.push(parseInt(l.substr(e,2),16));return String.fromCharCode.apply(String,i)}function w(){this.reset()}return w.prototype.append=function(l){return this.appendBinary(m(l)),this},w.prototype.appendBinary=function(l){this._buff+=l,this._length+=l.length;var i=this._buff.length,r;for(r=64;r<=i;r+=64)u(this._hash,h(this._buff.substring(r-64,r)));return this._buff=this._buff.substring(r-64),this},w.prototype.end=function(l){var i=this._buff,r=i.length,e,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s;for(e=0;e<r;e+=1)n[e>>2]|=i.charCodeAt(e)<<(e%4<<3);return this._finish(n,r),s=v(this._hash),l&&(s=S(s)),this.reset(),s},w.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},w.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},w.prototype.setState=function(l){return this._buff=l.buff,this._length=l.length,this._hash=l.hash,this},w.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},w.prototype._finish=function(l,i){var r=i,e,n,s;if(l[r>>2]|=128<<(r%4<<3),r>55)for(u(this._hash,l),r=0;r<16;r+=1)l[r]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(e[2],16),s=parseInt(e[1],16)||0,l[14]=n,l[15]=s,u(this._hash,l)},w.hash=function(l,i){return w.hashBinary(m(l),i)},w.hashBinary=function(l,i){var r=d(l),e=v(r);return i?S(e):e},w.ArrayBuffer=function(){this.reset()},w.ArrayBuffer.prototype.append=function(l){var i=R(this._buff.buffer,l,!0),r=i.length,e;for(this._length+=l.byteLength,e=64;e<=r;e+=64)u(this._hash,f(i.subarray(e-64,e)));return this._buff=e-64<r?new Uint8Array(i.buffer.slice(e-64)):new Uint8Array(0),this},w.ArrayBuffer.prototype.end=function(l){var i=this._buff,r=i.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n,s;for(n=0;n<r;n+=1)e[n>>2]|=i[n]<<(n%4<<3);return this._finish(e,r),s=v(this._hash),l&&(s=S(s)),this.reset(),s},w.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},w.ArrayBuffer.prototype.getState=function(){var l=w.prototype.getState.call(this);return l.buff=y(l.buff),l},w.ArrayBuffer.prototype.setState=function(l){return l.buff=_(l.buff,!0),w.prototype.setState.call(this,l)},w.ArrayBuffer.prototype.destroy=w.prototype.destroy,w.ArrayBuffer.prototype._finish=w.prototype._finish,w.ArrayBuffer.hash=function(l,i){var r=p(new Uint8Array(l)),e=v(r);return i?S(e):e},w})});var ht=N($(),1);function rt(a){for(var t,o,c,u=a.rev_tree.slice(),h;h=u.pop();){var f=h.ids,d=f[2],p=h.pos;if(d.length){for(var g=0,v=d.length;g<v;g++)u.push({pos:p+1,ids:d[g]});continue}var m=!!f[1].deleted,_=f[0];(!t||(c!==m?c:o!==p?o<p:t<_))&&(t=_,o=p,c=m)}return o+"-"+t}function st(a,t){for(var o=a.slice(),c;c=o.pop();)for(var u=c.pos,h=c.ids,f=h[2],d=t(f.length===0,u,h[0],c.ctx,h[1]),p=0,g=f.length;p<g;p++)o.push({pos:u+1,ids:f[p],ctx:d})}function nt(a){var t=[];return st(a.rev_tree,function(o,c,u,h,f){f.status==="available"&&!o&&(t.push(c+"-"+u),f.status="missing")}),t}function St(a){for(var t=[],o=a.slice(),c;c=o.pop();){var u=c.pos,h=c.ids,f=h[0],d=h[1],p=h[2],g=p.length===0,v=c.history?c.history.slice():[];v.push({id:f,opts:d}),g&&t.push({pos:u+1-v.length,ids:v});for(var m=0,_=p.length;m<_;m++)o.push({pos:u+1,ids:p[m],history:v})}return t.reverse()}function Rt(a,t){return a.pos-t.pos}function Tt(a,t,o){for(var c=0,u=a.length,h;c<u;)h=c+u>>>1,o(a[h],t)<0?c=h+1:u=h;return c}function Dt(a,t,o){var c=Tt(a,t,o);a.splice(c,0,t)}function tt(a,t){for(var o,c,u=t,h=a.length;u<h;u++){var f=a[u],d=[f.id,f.opts,[]];c?(c[2].push(d),c=d):o=c=d}return o}function At(a,t){return a[0]<t[0]?-1:1}function et(a,t){for(var o=[{tree1:a,tree2:t}],c=!1;o.length>0;){var u=o.pop(),h=u.tree1,f=u.tree2;(h[1].status||f[1].status)&&(h[1].status=h[1].status==="available"||f[1].status==="available"?"available":"missing");for(var d=0;d<f[2].length;d++){if(!h[2][0]){c="new_leaf",h[2][0]=f[2][d];continue}for(var p=!1,g=0;g<h[2].length;g++)h[2][g][0]===f[2][d][0]&&(o.push({tree1:h[2][g],tree2:f[2][d]}),p=!0);p||(c="new_branch",Dt(h[2],f[2][d],At))}}return{conflicts:c,tree:a}}function ot(a,t,o){var c=[],u=!1,h=!1,f;if(!a.length)return{tree:[t],conflicts:"new_leaf"};for(var d=0,p=a.length;d<p;d++){var g=a[d];if(g.pos===t.pos&&g.ids[0]===t.ids[0])f=et(g.ids,t.ids),c.push({pos:g.pos,ids:f.tree}),u=u||f.conflicts,h=!0;else if(o!==!0){var v=g.pos<t.pos?g:t,m=g.pos<t.pos?t:g,_=m.pos-v.pos,y=[],R=[];for(R.push({ids:v.ids,diff:_,parent:null,parentIdx:null});R.length>0;){var S=R.pop();if(S.diff===0){S.ids[0]===m.ids[0]&&y.push(S);continue}for(var w=S.ids[2],l=0,i=w.length;l<i;l++)R.push({ids:w[l],diff:S.diff-1,parent:S.ids,parentIdx:l})}var r=y[0];r?(f=et(r.ids,m.ids),r.parent[2][r.parentIdx]=f.tree,c.push({pos:v.pos,ids:v.ids}),u=u||f.conflicts,h=!0):c.push(g)}else c.push(g)}return h||c.push(t),c.sort(Rt),{tree:c,conflicts:u||"internal_node"}}function Ct(a,t){for(var o=St(a),c,u,h=0,f=o.length;h<f;h++){var d=o[h],p=d.ids,g;if(p.length>t){c||(c={});var v=p.length-t;g={pos:d.pos+v,ids:tt(p,v)};for(var m=0;m<v;m++){var _=d.pos+m+"-"+p[m].id;c[_]=!0}}else g={pos:d.pos,ids:tt(p,0)};u?u=ot(u,g,!0).tree:u=[g]}return c&&st(u,function(y,R,S){delete c[R+"-"+S]}),{tree:u,revs:c?Object.keys(c):[]}}function at(a,t,o){var c=ot(a,t),u=Ct(c.tree,o);return{tree:u.tree,stemmedRevs:u.revs,conflicts:c.conflicts}}var it=N($(),1),xt=32768,ct=async a=>{let t=Math.min(xt,a.size),o=Math.ceil(a.size/t),c=new it.default.ArrayBuffer;for(let u=0;u<o;u++){let f=await a.slice(u*t,(u+1)*t).arrayBuffer();c.append(f)}return c.end(!0)},j=()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,a=>(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)),x=class extends TransformStream{constructor({batchSize:t}){super({start(){},transform(o,c){if(this.entries.push(o),this.entries.length>=t){let u=this.entries.splice(0,t);c.enqueue(u)}},flush(o){this.entries.length>0&&o.enqueue(this.entries)},entries:[]})}},ut=a=>{let t=new CompressionStream("gzip"),o=a.stream().pipeThrough(t);return new Response(o).blob()},lt=(a,t)=>{let o=new DecompressionStream("gzip"),c=a.stream().pipeThrough(o),u={headers:{"Content-Type":t}};return new Response(c,u).blob()};var D="docs",C="meta",qt=1e3,W={status:"available"},ft={status:"missing"},Ut=a=>{let[t,o]=a.split("-");return[parseInt(t,10),o]},Bt=a=>{let t=a.start-a.ids.length+1,o=a.ids,c=[o[0],W,[]];for(let u=1,h=o.length;u<h;u++)c=[o[u],ft,[c]];return[{pos:t,ids:c}]},Et=async a=>{let t=await ct(a);return`md5-${btoa(t)}`},It=a=>{let t={};for(let c in a)c!=="_revisions"&&(t[c]=a[c]);let o=JSON.stringify(t);return ht.default.hash(o)},Pt=async(a,t,o)=>{if(!a)return t;for(let c in a){let u=a[c],{stub:h}=u;if(h){let{digest:f}=u;t[f].revs[o]=!0}else{let{content_type:f,data:d}=u;if(typeof d=="string")throw new Error("Base64 attachments are not supported");let p=u.digest||await Et(d);u.digest=p,u.revpos=parseInt(o,10),t[p]={data:d,revs:{[o]:!0}}}}return t},Lt=a=>{let t={};for(let o in a)o.startsWith("_")||(t[o]=a[o]);if(a._attachments){t._attachments={};for(let o in a._attachments){let{digest:c,revpos:u}=a._attachments[o];t._attachments[o]={digest:c,revpos:u}}}return t},Ft=async(a,t,o,{newEdits:c}={newEdits:!0})=>{let u;if(c){let n=await It(t),s;if(t._rev){let[b,T]=Ut(t._rev);s=b+1,u=[{pos:b,ids:[T,ft,[[n,W,[]]]]}]}else s=1,u=[{pos:1,ids:[n,W,[]]}];t._rev=`${s}-${n}`}else u=Bt(t._revisions);let{_id:h,_rev:f,_deleted:d,_attachments:p}=t,g=o?o.attachments:{},v=await Pt(p,g,f),m=Lt(t),_=o?o.rev_tree:[],{tree:y,stemmedRevs:R}=at(_,u[0],qt),S=rt({rev_tree:y}),l={...o?o.revs:null,[f]:{data:m,deleted:!!d}},i=l[S].deleted,e=nt({rev_tree:y}).concat(R);for(let n of e)delete l[n];return{attachments:v,deleted:i,id:h,rev:S,rev_tree:y,revs:l,seq:a}},q=class{constructor({name:t}){this.name=t,this.db=null,this.metadata=null}async init(){if(!this.db)return new Promise((t,o)=>{let c=indexedDB.open(this.name);c.onupgradeneeded=u=>{let h=u.target.result,f="id";h.createObjectStore(D,{keyPath:f}).createIndex("seq","seq",{unique:!0}),h.createObjectStore(C,{keyPath:f})},c.onsuccess=u=>{this.db=u.target.result,this.db.onabort=()=>this.db.close(),this.db.onversionchange=()=>this.db.close();let h=this.db.transaction(C,"readwrite");h.oncomplete=()=>t();let f=h.objectStore(C);f.get(C).onsuccess=d=>{this.metadata=d.target.result||{id:C};let p=!1;"doc_count"in this.metadata||(p=!0,this.metadata.doc_count=0),"seq"in this.metadata||(p=!0,this.metadata.seq=0),"db_uuid"in this.metadata||(p=!0,this.metadata.db_uuid=j()),p&&f.put(this.metadata)}},c.onerror=u=>o(u.target.error),c.onblocked=u=>o(u)})}destroy(){return new Promise((t,o)=>{this.db.close();let c=indexedDB.deleteDatabase(this.name);c.onsuccess=()=>{this.db=null,this.metadata=null,t()}})}getLocalDoc(t){let o=`_local/${t}`;return new Promise((c,u)=>{this.db.transaction(D,"readonly").objectStore(D).get(o).onsuccess=h=>{let f=h.target.result,d=f?f.data:{_id:o};c(d)}})}saveLocalDoc(t){return t._rev=t._rev?t._rev+1:1,new Promise((o,c)=>{let u={id:t._id,data:t};this.db.transaction(D,"readwrite").objectStore(D).put(u).onsuccess=()=>o({rev:t._rev})})}getDocStore(t){return this.db.transaction(D,t).objectStore(D)}async buildEntries(t){let o=[];for(let{doc:c,existingEntry:u}of t){let h=++this.metadata.seq,f=await Ft(h,c,u,{newEdits:!1}),d,{deleted:p}=f;u?u.deleted?d=p?0:1:d=p?-1:0:d=p?0:1,this.metadata.doc_count+=d,o.push(f)}return o}async saveEntries(t){return new Promise((o,c)=>{let u=this.db.transaction([D,C],"readwrite"),h=u.objectStore(D),f=u.objectStore(C),d=0,p=t.length;for(let g of t)h.put(g).onsuccess=()=>{d++,p--,p===0&&(f.put(this.metadata).onsuccess=()=>o(d))}})}async saveDocs(t){let o=await this.buildEntries(t);return this.saveEntries(o)}};var V=class extends TransformStream{constructor(t){super({start(){},async transform(o,c){return new Promise((u,h)=>{let f=t.getDocStore("readonly"),d=o.length;for(let p of o){let{id:g,revs:v}=p;f.get(g).onsuccess=m=>{d--;let _=m.target.result;_?c.enqueue({id:g,revs:v.filter(y=>y in _.revs),entry:_}):c.enqueue({id:g,revs:v}),d===0&&u()}}})},flush(){}})}},z=class extends WritableStream{constructor(t,o={}){super({async write(c){this.docsWritten+=await t.saveDocs(c)},close(){},docsWritten:0})}},U=class{constructor(t){this.database=t}getUuid(){let{db_uuid:t}=this.database.metadata;return t}getUpdateSeq(){let{seq:t}=this.database.metadata;return t}getReplicationLog(t){return this.database.getLocalDoc(t)}saveReplicationLog(t){return this.database.saveLocalDoc(t)}getChanges(t,{limit:o}={},c={}){throw new Error("Not supported for Local yet")}filterMissingRevs(){return new V(this.database)}getDocs(t={}){throw new Error("Not supported for Local yet")}saveDocs(t={}){return new z(this.database,t)}};var B=class{constructor({name:t}){this.database=new q({name:t}),this.replicator=new U(this.database)}init(){return this.database.init()}destroy(){return this.database.destroy()}};var E=class{constructor({url:t,headers:o}){this.url=t,this.root=t.pathname,this.headers=o}async getServerInfo(){let t=new URL(this.url);t.pathname="/";let o=await fetch(t,{headers:this.headers});if(o.status!==200)throw new Error("Remote server not reachable");return o.json()}async getInfo(){let t=new URL(this.url),o=await fetch(t,{headers:this.headers});if(o.status!==200)throw new Error("Remote database not reachable");return o.json()}async getDoc(t){let o=new URL(`${this.root}/${t}`,this.url),c=await fetch(o,{headers:this.headers});if(c.status!==200)throw new Error("Could not get doc");return c.json()}async saveDoc(t){let o=new URL(`${this.root}/${t._id}`,this.url),c=await fetch(o,{headers:{...this.headers,"Content-Type":"application/json"},method:"put",body:JSON.stringify(t)});if(c.status!==201)throw new Error("Could not save doc");return c.json()}};function I(a,t,o=0){if(o>a.length+t.length+2)return-1;for(let c=o;c<a.length;c++)if(a[c]===45&&a[c+1]===45){let u,h;for(h=0;h<t.length;h++)if(u=!0,a[h+c+2]!==t[h]){u=!1;break}if(u)return c}return-1}function J(a,t=0){if(t>a.length+4)return-1;for(let o=t;o<a.length;o++)if(a[o]===13&&a[o+1]===10&&a[o+2]===13&&a[o+3]===10)return o;return-1}function H(a,t,o=0){if(o>a.length+t.length+4||a[o]!==45||a[o+1]!==45||a[o+t.length+2]!==45||a[o+t.length+3]!==45)return!1;for(let c=0;c<t.length;c++)if(a[c+o+2]!==t[c])return!1;return!0}var P=class{constructor(t){this.encoder=new TextEncoder,this.decoder=new TextDecoder;let o=this.parseContentType(t);this.id=o.id,this.boundaries=[o]}parseContentType(t){let[o,c,u]=t.match(/^([^;]+);\s*boundary="?([^="]+)"?/)||[];if(c!=="multipart/related")return;let h=this.encoder.encode(u);return{id:u,boundary:h}}parsePart(t){if(this.boundaries.length===0)return null;let{id:o,boundary:c}=this.boundaries[this.boundaries.length-1],u=I(t,c);if(u===-1)return null;let h=J(t,u);if(h===-1)return null;let f=t.slice(c.length+4,h),p=this.decoder.decode(f).split(`\r
`).reduce((l,i)=>{let[r,e]=i.split(/:\s*/);return l[r]=r==="Content-Length"?parseInt(e,10):e,l},{}),{"Content-Type":g}=p;if(!g)return null;let{"Content-Length":v}=p,m=v?I(t,c,v+h+6):I(t,c,h+4);if(m===-1||t.length<m)return null;let _=this.parseContentType(g);if(_)return this.boundaries.push(_),this.parsePart(t.slice(h+4));let y=H(t,c,m),R=y?m+c.length+6:m;y&&this.boundaries.pop();let S=t.slice(h+4,m-2),w=t.slice(R);return{boundary:this.id===o?null:o,headers:p,data:S,rest:w}}};var L=class{constructor(t){this.parser=new P(t),this.data=new Uint8Array(0)}read(t){if(t){let u=new Uint8Array(this.data.length+t.length);u.set(this.data,0),u.set(t,this.data.length),this.data=u}let o=[],c;do if(c=this.parser.parsePart(this.data),c){let{boundary:u,headers:h,data:f,rest:d}=c;this.data=d,o.push({boundary:u,headers:h,data:f})}while(c);return o}};var Mt=(a,t=0)=>{if(t>a.length+4)return[-1];for(let o=t;o<a.length;o++){if(a[o]===125&&a[o+1]===44&&a[o+2]===13&&a[o+3]===10&&a[o+4]===123)return[o];if(a[o]===10&&a[o+1]===93&&a[o+2]===44)return[o,!0]}return[-1]},G=class extends TransformStream{constructor(t={}){t.numberOfChanges=0,t.lastSeq=null,super({start(){},transform(o,c){let u=new Uint8Array(this.data.length+o.length);u.set(this.data,0),u.set(o,this.data.length),this.data=u,this.startParsed||(this.data=this.data.slice(13),this.startParsed=!0);let h;do{h=null;let[f,d]=Mt(this.data);if(f!==-1){if(f>0){let p=this.decoder.decode(this.data.slice(0,f+1));h=JSON.parse(p);let{id:g,changes:v,deleted:m}=h,_=v.map(({rev:R})=>R),y={id:g,revs:_};m&&(y.deleted=!0),t.numberOfChanges++,c.enqueue(y)}if(d){let p=this.decoder.decode(this.data.slice(f+4)),{last_seq:g}=JSON.parse(`{${p}`);t.lastSeq=g;return}this.data=this.data.slice(f+4)}}while(h)},flush(){},decoder:new TextDecoder,data:new Uint8Array(0),startParsed:!1})}},$t=async(a,{decoder:t})=>{if(a.length===0)return;let{headers:o,data:c}=a.shift(),u=t.decode(c),h=JSON.parse(u);for(let{headers:f,data:d}of a){let p=f["Content-Disposition"];if(!p){console.warn("skipping attachment with missing Content-Disposition header",f,h,a);continue}let[g,v]=p.match(/filename="([^"]+)"/);if(!v){console.warn('missing filename in Content-Disposition header "%s"',p,f,h,a);continue}if(!(v in h._attachments)){console.warn('skipping attachment due to missing filename "%s" in docs attachments stub',v,f,h,a);continue}let m=f["Content-Type"];if(!m){console.warn("skipping attachment due to missing Content-Type header",f,h,a);continue}let _=new Blob([d],{type:m}),y=f["Content-Encoding"];if(y==="gzip")h._attachments[v].data=await lt(_,m),delete h._attachments[v].follows,delete h._attachments[v].encoding,delete h._attachments[v].encoded_length;else if(y){console.warn("skipping attachment with unsupported Content-Encoding header %s",y,f,h,a);continue}else h._attachments[v].data=_,delete h._attachments[v].follows}return h},K=class extends TransformStream{constructor(t,o){o.docsRead=0;let c=new TextDecoder;super({start(){},async transform(u,h){let f=[],d={};for(let{id:e,revs:n,entry:s}of u){d[e]=s;for(let b of n)f.push({id:e,rev:b})}let p=async e=>{let n=await $t(e,{decoder:c});if(n){let s=d[n._id];h.enqueue({doc:n,entry:s}),o.docsRead++}},g=new URL(`${t.root}/_bulk_get`,t.url);g.searchParams.set("revs","true"),g.searchParams.set("attachments","true");let v={docs:f},m=new Blob([JSON.stringify(v)],{type:"application/json"}),_=await ut(m),y=await fetch(g,{headers:{...t.headers,"Content-Type":"application/json",Accept:"multipart/related","Content-Encoding":"gzip"},method:"post",body:_});if(y.status!==200)throw new Error("Could not get docs multipart");let R=y.headers.get("Content-Type"),S=new L(R),w=y.body.getReader(),l=!1,i=[],r=null;do{let{done:e,value:n}=await w.read(),s=S.read(n);for(let b of s)b.boundary?r&&r!==b.boundary?(p(i),i=[b],r=null):(i.push(b),r=b.boundary):(p(i),i=[],r=null,p([b]));l=e}while(!l);p(i)},flush(){}},{highWaterMark:8})}},F=class{constructor(t){this.database=t}async getUuid(){let{uuid:t}=await this.database.getServerInfo();return t}async getUpdateSeq(){let{update_seq:t}=await this.database.getInfo();return t}async getReplicationLog(t){let o=`_local/${t}`;try{return await this.database.getDoc(o)}catch{return{_id:o}}}saveReplicationLog(t){return this.database.saveDoc(t)}async getChanges(t,{limit:o}={},c={}){let u=new URL(`${this.database.root}/_changes`,this.database.url);u.searchParams.set("feed","normal"),u.searchParams.set("style","all_docs"),t&&u.searchParams.set("since",t),o&&(u.searchParams.set("limit",o),u.searchParams.set("seq_interval",o));let h=await fetch(u,{headers:this.database.headers});if(h.status!==200)throw new Error("Could not get changes");let f=new G(c),d=h.body.getReader();return new ReadableStream({async start(g){for(;;){let{done:v,value:m}=await d.read();if(v)break;g.enqueue(m)}g.close(),d.releaseLock()}}).pipeThrough(f)}filterMissingRevs(){throw new Error("Not supported for Remote yet")}getDocs(t={}){return new K(this.database,t)}saveDocs(t={}){throw new Error("Not supported for Remote yet")}};var M=class{constructor({url:t,headers:o}){this.database=new E({url:t,headers:o}),this.replicator=new F(this.database)}};var pt=N($(),1);var jt=async(a,t)=>pt.default.hash(`${a}${t}`),Ot=(a,t)=>a.session_id&&a.session_id===t.session_id&&a.source_last_seq&&a.source_last_seq===t.source_last_seq?a.source_last_seq:null,dt=(a,t)=>{if(!a)return-1;if(!t)return 1;if(a===t)return 0;let o=parseInt(a,10),c=parseInt(t,10);return o-c};async function O(a,t,{batchSize:o={getChanges:512*8,getDiff:512,getDocs:1024,saveDocs:512}}={}){let c=j(),u={docsRead:0,docsWritten:0},[h,f,d]=await Promise.all([t.replicator.getUuid(),a.replicator.getUuid(),a.replicator.getUpdateSeq()]),p=await jt(h,f),[g,v]=await Promise.all([t.replicator.getReplicationLog(p),a.replicator.getReplicationLog(p)]),m=Ot(g,v);if(dt(m,d)===0)return u;let _=!1;for(;!_;){let y={},R=await a.replicator.getChanges(m,{limit:o.getChanges},y),S=t.replicator.filterMissingRevs(),w=a.replicator.getDocs(y),l=t.replicator.saveDocs(y),i=new WritableStream({write(r){console.log(r)},close(){console.log("complete.")}});if(await R.pipeThrough(new x({batchSize:o.getDiff})).pipeThrough(S).pipeThrough(new x({batchSize:o.getDocs})).pipeThrough(w).pipeThrough(new x({batchSize:o.saveDocs})).pipeTo(l),u.lastSeq=y.lastSeq,u.docsRead+=y.docsRead,u.docsWritten+=y.docsWritten,y.lastSeq!==m){v.session_id=c,v.source_last_seq=y.lastSeq,g.session_id=c,g.source_last_seq=y.lastSeq;let[{rev:r},{rev:e}]=await Promise.all([t.replicator.saveReplicationLog(g),a.replicator.saveReplicationLog(v)]);g._rev=r,v._rev=e}m=y.lastSeq,_=y.numberOfChanges<o.getChanges||dt(y.lastSeq,d)>=0}return u}var Nt=new Event("change"),Z=class extends EventTarget{constructor({name:t,url:o,headers:c}){super(),this.local=new B({name:t}),this.remote=new M({url:o,headers:c})}init(){return this.local.init()}async pull(){console.time("pull");let t=await O(this.remote,this.local);return console.timeEnd("pull"),t.docsWritten>0&&this.dispatchEvent(Nt),t}push(){return O(this.local,this.remote)}sync(){return Promise.all([this.pull(),this.push()])}};export{Z as default};
